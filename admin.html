<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoffeeMoll Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .login-container { max-width: 400px; margin: 80px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .dashboard-container { max-width: 1000px; margin: 30px auto; display: none; }
        .item-row { background: white; border: 1px solid #e1e4e8; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .item-row:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .bg-success { background-color: #88d100 !important; }
        .bg-danger { background-color: #dc3545 !important; }
        .cat-header { font-weight: 700; color: #6c757d; margin: 25px 0 10px 0; border-bottom: 2px solid #dee2e6; padding-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-edit { font-size: 0.85rem; padding: 4px 12px; border-radius: 6px; }
        .form-check-input:checked { background-color: #88d100; border-color: #88d100; }
        .config-block { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏ –æ–±—ä–µ–º–æ–≤ */
        .mod-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f8f9fa; }
        .mod-row:last-child { border-bottom: none; }
        .mod-price-inp { width: 90px; text-align: right; padding: 4px; font-size: 0.9em; }
        .vol-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .vol-input { flex: 1; }
        .vol-price { width: 100px; }
        .section-title { font-size: 0.9rem; font-weight: bold; color: #6c757d; text-transform: uppercase; margin-bottom: 10px; margin-top: 15px; padding-bottom: 5px; border-bottom: 2px solid #eee; }
    </style>
</head>
<body>

<div class="container" id="login-screen">
    <div class="login-container text-center">
        <h3 class="mb-4">üîê CoffeeMoll Admin</h3>
        <input type="email" id="email" class="form-control mb-3" placeholder="Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
        <input type="password" id="password" class="form-control mb-3" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" class="btn btn-dark w-100 py-2">–í–æ–π—Ç–∏</button>
        <div id="login-msg" class="text-danger mt-3 small"></div>
    </div>
</div>

<div class="container dashboard-container" id="admin-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="m-0">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–µ–Ω—é</h4>
        <button onclick="logout()" class="btn btn-outline-danger btn-sm">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ—Ñ–µ–π–Ω–∏ -->
    <div class="config-block">
        <h6 class="text-muted mb-3">üõ† –ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h6>
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="promo-switch" onchange="updateSettings()">
                    <label class="form-check-label">–ü—Ä–æ–º–æ–∫–æ–¥—ã</label>
                </div>
            </div>
            <div class="col-auto">
                <input type="time" class="form-control form-control-sm" id="open-time" onchange="updateSettings()">
            </div>
            <div class="col-auto text-muted">-</div>
            <div class="col-auto">
                <input type="time" class="form-control form-control-sm" id="close-time" onchange="updateSettings()">
            </div>
            <div class="col-auto">
                <span id="settings-status" class="badge bg-secondary">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    </div>

    <input type="text" id="search" class="form-control mb-4 p-3 shadow-sm" placeholder="üîç –ù–∞–π—Ç–∏ –±–ª—é–¥–æ..." oninput="renderList()">
    <div id="menu-list"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
          <input type="hidden" id="edit-id">
          
          <div class="row">
              <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –û–°–ù–û–í–ù–û–ï -->
              <div class="col-md-4">
                  <div class="section-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                  <div class="mb-3">
                      <label class="form-label small text-muted">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                      <input type="text" id="edit-name" class="form-control fw-bold">
                  </div>

                  <div class="row">
                      <div class="col-6 mb-3">
                          <label class="form-label small text-muted">–¶–µ–Ω–∞ (–±–∞–∑–æ–≤–∞—è)</label>
                          <input type="number" id="edit-price" class="form-control">
                      </div>
                      <div class="col-6 mb-3 d-flex align-items-end">
                          <div class="form-check form-switch w-100 p-2 border rounded">
                              <input class="form-check-input ms-0 me-2" type="checkbox" id="edit-available">
                              <label class="form-check-label">–í –Ω–∞–ª–∏—á–∏–∏</label>
                          </div>
                      </div>
                  </div>
                  
                  <div class="mb-3">
                      <label class="form-label small text-muted">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                      <textarea id="edit-desc" class="form-control" rows="4"></textarea>
                  </div>
                  
                  <div class="mb-3">
                       <label class="form-label small text-muted">–ë–µ–π–¥–∂ (–∞–∫—Ü–∏—è/–æ—Å—Ç—Ä–æ–µ)</label>
                       <input type="text" id="edit-badge" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–ò–¢">
                  </div>
              </div>

              <!-- –°–†–ï–î–ù–Ø–Ø –ö–û–õ–û–ù–ö–ê: –û–ë–™–ï–ú–´ -->
              <div class="col-md-4 border-start border-end">
                  <div class="section-title d-flex justify-content-between">
                      <span>–û–±—ä–µ–º—ã / –ü–æ—Ä—Ü–∏–∏</span>
                      <button class="btn btn-sm btn-outline-success py-0" onclick="addVolumeRow()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                  </div>
                  <div class="small text-muted mb-2 fst-italic">–ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—ä–µ–º—ã, –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.</div>
                  <div id="volumes-container">
                      <!-- –°—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ –æ–±—ä–µ–º–æ–≤ -->
                  </div>
              </div>

              <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ -->
              <div class="col-md-4">
                  <div class="section-title">–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã</div>
                  <div class="small text-muted mb-2">–û—Ç–º–µ—Ç—å—Ç–µ, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —ç—Ç–æ –±–ª—é–¥–æ.</div>
                  <div id="modifiers-container" style="max-height: 500px; overflow-y: auto;">
                      <!-- –°—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —á–µ–∫–±–æ–∫—Å—ã –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
                  </div>
              </div>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-success fw-bold px-4" onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, doc, updateDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // üî¥üî¥üî¥ –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –ö–û–ù–§–ò–ì –ò–ó FIREBASE CONSOLE üî¥üî¥üî¥
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  let menuData = [];

  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
  const MOD_CONFIG = [
      { key: 'milk', label: '–ú–æ–ª–æ–∫–æ (–æ–±—ã—á–Ω–æ–µ)', def: 50 },
      { key: 'alt_milk', label: '–ê–ª—å—Ç. –º–æ–ª–æ–∫–æ', def: 400 },
      { key: 'cream', label: '–°–ª–∏–≤–∫–∏', def: 50 },
      { key: 'syrup', label: '–°–∏—Ä–æ–ø', def: 0 },
      { key: 'sugar', label: '–°–∞—Ö–∞—Ä', def: 0 },
      { key: 'honey', label: '–ú–µ–¥', def: 100 },
      { key: 'lemon', label: '–õ–∏–º–æ–Ω', def: 50 },
      { key: 'cinnamon', label: '–ö–æ—Ä–∏—Ü–∞', def: 0 },
      { key: 'shot', label: '–î–æ–ø. —à–æ—Ç', def: 300 },
      { key: 'egg', label: '–Ø–π—Ü–æ', def: 70 },
      { key: 'cheese', label: '–°—ã—Ä', def: 150 },
      { key: 'jalapeno', label: '–•–∞–ª–∞–ø–µ–Ω—å–æ', def: 150 },
      { key: 'onion', label: '–ñ–∞—Ä. –ª—É–∫', def: 150 },
      { key: 'sauce', label: '–°–æ—É—Å', def: 150 }
  ];

  // --- AUTH ---
  window.login = () => {
      const e = document.getElementById('email').value;
      const p = document.getElementById('password').value;
      const btn = document.querySelector('button[onclick="login()"]');
      btn.disabled = true; btn.innerText = "–í—Ö–æ–¥–∏–º...";
      
      signInWithEmailAndPassword(auth, e, p)
        .then(() => { document.getElementById('login-msg').innerText = ""; })
        .catch(err => { 
            document.getElementById('login-msg').innerText = "–û—à–∏–±–∫–∞: " + err.message; 
            btn.disabled = false; btn.innerText = "–í–æ–π—Ç–∏";
        });
  }
  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
      if(user) {
          document.getElementById('login-screen').style.display = 'none';
          document.querySelector('.dashboard-container').style.display = 'block';
          initData();
          initSettings();
      } else {
          document.getElementById('login-screen').style.display = 'block';
          document.querySelector('.dashboard-container').style.display = 'none';
      }
  });

  // --- DATA ---
  function initData() {
      onSnapshot(collection(db, "menu"), (snapshot) => {
          menuData = [];
          snapshot.forEach(doc => menuData.push({ _id: doc.id, ...doc.data() }));
          renderList();
      });
  }
  
  function initSettings() {
      onSnapshot(doc(db, "settings", "main"), (doc) => {
          if(doc.exists()) {
              const d = doc.data();
              document.getElementById('open-time').value = d.open_time || "09:00";
              document.getElementById('close-time').value = d.close_time || "23:00";
              document.getElementById('promo-switch').checked = (String(d.enable_promos) === "true");
              document.getElementById('settings-status').innerText = "–ê–∫—Ç–∏–≤–Ω–æ";
              document.getElementById('settings-status').className = "badge bg-success";
          }
      });
  }

  window.updateSettings = async () => {
      const updates = {
          open_time: document.getElementById('open-time').value,
          close_time: document.getElementById('close-time').value,
          enable_promos: String(document.getElementById('promo-switch').checked)
      };
      document.getElementById('settings-status').innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
      await updateDoc(doc(db, "settings", "main"), updates);
  }

  window.renderList = () => {
      const q = document.getElementById('search').value.toLowerCase();
      const cont = document.getElementById('menu-list');
      cont.innerHTML = '';

      const categories = {};
      const order = ["–ò–ó–ë–†–ê–ù–ù–û–ï", "–ü–û–ü–£–õ–Ø–†–ù–û–ï", "–°–ï–ó–û–ù–ù–û–ï", "–ö–û–§–ï", "–ß–ê–ô", "–î–ï–°–ï–†–¢–´", "–•–û–õ–û–î–ù–´–ï –ù–ê–ü–ò–¢–ö–ò", "–ú–û–õ–û–ß–ù–´–ï –ö–û–ö–¢–ï–ô–õ–ò", "–ó–ê–í–¢–†–ê–ö–ò", "–ö–†–£–ê–°–°–ê–ù–´", "–•–û–¢-–î–û–ì–ò", "–°–ê–õ–ê–¢–´", "–ü–ò–¶–¶–ê", "–ü–ê–°–¢–´", "–ó–ê–ö–£–°–ö–ò"];
      
      menuData.forEach(item => {
          if (!item.name.toLowerCase().includes(q)) return;
          if (!categories[item.category]) categories[item.category] = [];
          categories[item.category].push(item);
      });

      const sortedCats = Object.keys(categories).sort((a,b) => {
         let idxA = order.indexOf(a.toUpperCase());
         let idxB = order.indexOf(b.toUpperCase());
         if(idxA === -1) idxA = 999;
         if(idxB === -1) idxB = 999;
         return idxA - idxB;
      });

      sortedCats.forEach(cat => {
          cont.innerHTML += `<div class="cat-header">${cat}</div>`;
          categories[cat].forEach(item => {
              const opacity = item.available ? '1' : '0.5';
              const dotClass = item.available ? 'bg-success' : 'bg-danger';
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—É –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω
              let priceDisplay = item.price + " ‚Ç∏";
              if(item.volumes && item.volumes.length > 0) {
                  priceDisplay = "–æ—Ç " + item.volumes[0].p + " ‚Ç∏";
              }

              cont.innerHTML += `
              <div class="item-row" style="opacity: ${opacity}">
                  <div class="d-flex align-items-center">
                      <span class="status-dot ${dotClass}"></span>
                      <div>
                          <div class="fw-bold text-dark">${item.name}</div>
                          <div class="small text-muted">${priceDisplay}</div>
                      </div>
                  </div>
                  <button class="btn btn-outline-dark btn-edit" onclick="openEdit('${item._id}')">‚úèÔ∏è</button>
              </div>`;
          });
      });
  }

  // --- EDIT MODAL LOGIC ---
  const modal = new bootstrap.Modal(document.getElementById('editModal'));

  window.openEdit = (id) => {
      const item = menuData.find(i => i._id === id);
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-name').value = item.name;
      document.getElementById('edit-price').value = item.price || 0;
      document.getElementById('edit-desc').value = item.description || "";
      document.getElementById('edit-badge').value = item.badge || "";
      document.getElementById('edit-available').checked = item.available;
      document.getElementById('modal-title').innerText = item.name;

      // 1. –†–µ–Ω–¥–µ—Ä –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
      const modContainer = document.getElementById('modifiers-container');
      modContainer.innerHTML = '';
      const currentMods = item.modifiers || {};
      
      MOD_CONFIG.forEach(conf => {
          const isChecked = conf.key in currentMods;
          const currentPrice = isChecked ? currentMods[conf.key] : conf.def;
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö —Ü–µ–Ω (–µ—Å–ª–∏ –º–∞—Å—Å–∏–≤) - –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
          let displayPrice = currentPrice;
          if(Array.isArray(currentPrice)) displayPrice = currentPrice[0];

          modContainer.innerHTML += `
          <div class="mod-row">
              <div class="form-check mb-0">
                  <input class="form-check-input mod-cb" type="checkbox" id="mod_cb_${conf.key}" data-key="${conf.key}" ${isChecked ? 'checked' : ''}>
                  <label class="form-check-label small" for="mod_cb_${conf.key}">${conf.label}</label>
              </div>
              <input type="number" class="form-control form-control-sm mod-price-inp" id="mod_pr_${conf.key}" value="${displayPrice}" placeholder="–¶–µ–Ω–∞">
          </div>`;
      });

      // 2. –†–µ–Ω–¥–µ—Ä –æ–±—ä–µ–º–æ–≤
      const volContainer = document.getElementById('volumes-container');
      volContainer.innerHTML = '';
      const vols = item.volumes || [];
      
      if(vols.length > 0) {
          vols.forEach(v => addVolumeRow(v.n, v.p));
      }
      
      modal.show();
  }

  window.addVolumeRow = (name = '', price = '') => {
      const div = document.createElement('div');
      div.className = 'vol-row';
      div.innerHTML = `
          <input type="text" class="form-control form-control-sm vol-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (0.3)" value="${name}">
          <input type="number" class="form-control form-control-sm vol-price" placeholder="–¶–µ–Ω–∞" value="${price}">
          <button class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">‚úï</button>
      `;
      document.getElementById('volumes-container').appendChild(div);
  }

  window.saveItem = async () => {
      const id = document.getElementById('edit-id').value;
      
      // –°–±–æ—Ä –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
      const modifiers = {};
      document.querySelectorAll('.mod-cb').forEach(cb => {
          if(cb.checked) {
              const key = cb.dataset.key;
              const priceVal = document.getElementById(`mod_pr_${key}`).value;
              modifiers[key] = parseInt(priceVal) || 0;
          }
      });

      // –°–±–æ—Ä –æ–±—ä–µ–º–æ–≤
      const volumes = [];
      document.querySelectorAll('.vol-row').forEach(row => {
          const inputs = row.querySelectorAll('input');
          const n = inputs[0].value.trim();
          const p = parseInt(inputs[1].value);
          if(n && !isNaN(p)) {
              volumes.push({n, p});
          }
      });

      const updates = {
          name: document.getElementById('edit-name').value,
          price: parseInt(document.getElementById('edit-price').value) || 0,
          description: document.getElementById('edit-desc').value,
          badge: document.getElementById('edit-badge').value,
          available: document.getElementById('edit-available').checked,
          modifiers: modifiers,
          volumes: volumes
      };
      
      try {
          await updateDoc(doc(db, "menu", id), updates);
          modal.hide();
      } catch (e) {
          alert("–û—à–∏–±–∫–∞: " + e.message);
      }
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
