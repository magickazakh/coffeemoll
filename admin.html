<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoffeeMoll Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f4f6f9; font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .login-container { max-width: 400px; margin: 80px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .main-container { max-width: 1200px; margin: 30px auto; display: none; padding: 0 15px; }
        
        /* –¢–∞–±—ã */
        .nav-pills .nav-link { color: #495057; margin-right: 5px; border-radius: 8px; font-weight: 500; }
        .nav-pills .nav-link.active { background-color: #212529; color: #88d100; }
        .nav-pills .nav-link i { margin-right: 5px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card-shadow { background: white; border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 15px; }
        
        /* –ú–µ–Ω—é */
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0; transition: 0.1s; }
        .item-row:hover { background: #f8f9fa; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        
        /* –ó–∞–∫–∞–∑—ã */
        .order-card { border-left: 4px solid #88d100; }
        
        /* –ö–ª–∏–µ–Ω—Ç—ã */
        .user-avatar { width: 40px; height: 40px; background: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #495057; margin-right: 10px; }
        
        /* –ü—Ä–æ–º–æ–∫–æ–¥—ã */
        .promo-code { font-family: monospace; font-size: 1.1em; letter-spacing: 1px; background: #eee; padding: 2px 6px; border-radius: 4px; }
        
        /* –û–±—â–µ–µ */
        .bg-success { background-color: #88d100 !important; color: #000; }
        .text-accent { color: #88d100; }
        
        /* –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã */
        .mod-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f8f9fa; }
        .mod-price-inp { width: 90px; text-align: right; font-size: 0.9em; padding: 4px; }
    </style>
</head>
<body>

<!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
<div class="container" id="login-screen">
    <div class="login-container text-center">
        <h3 class="mb-4 fw-bold">‚òï CoffeeMoll <span class="text-accent">Admin</span></h3>
        <input type="email" id="email" class="form-control mb-3" placeholder="Email">
        <input type="password" id="password" class="form-control mb-3" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" class="btn btn-dark w-100 py-2 fw-bold">–í–æ–π—Ç–∏</button>
        <div id="login-msg" class="text-danger mt-3 small"></div>
    </div>
</div>

<!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
<div class="main-container" id="dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="m-0 fw-bold">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
        <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏</button>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <ul class="nav nav-pills mb-4" id="pills-tab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-menu"><i class="fas fa-coffee"></i> –ú–µ–Ω—é</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-orders" onclick="loadOrders()"><i class="fas fa-list-ul"></i> –ó–∞–∫–∞–∑—ã</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-users" onclick="loadUsers()"><i class="fas fa-users"></i> –ö–ª–∏–µ–Ω—Ç—ã</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-promos" onclick="loadPromos()"><i class="fas fa-ticket-alt"></i> –ü—Ä–æ–º–æ–∫–æ–¥—ã</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reviews" onclick="loadReviews()"><i class="fas fa-star"></i> –û—Ç–∑—ã–≤—ã</button></li>
    </ul>

    <div class="tab-content">
        
        <!-- 1. –ú–ï–ù–Æ -->
        <div class="tab-pane fade show active" id="tab-menu">
            <div class="card card-shadow p-3">
                <div class="row g-2 align-items-center mb-3">
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="promo-switch" onchange="updateSettings()">
                            <label class="form-check-label small fw-bold">–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ —Å–∞–π—Ç–µ</label>
                        </div>
                    </div>
                    <div class="col-md-6 d-flex gap-2">
                        <input type="time" class="form-control form-control-sm" id="open-time" onchange="updateSettings()" title="–û—Ç–∫—Ä—ã—Ç–∏–µ">
                        <span class="text-muted">-</span>
                        <input type="time" class="form-control form-control-sm" id="close-time" onchange="updateSettings()" title="–ó–∞–∫—Ä—ã—Ç–∏–µ">
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-sm btn-light border" type="button" data-bs-toggle="collapse" data-bs-target="#settingsCollapse">‚öôÔ∏è –°–ø–∏—Å–∫–∏</button>
                    </div>
                </div>
                <div class="collapse" id="settingsCollapse">
                    <div class="row g-2 mb-3">
                        <div class="col-4"><small class="text-muted">–°–∏—Ä–æ–ø—ã</small><textarea id="set-syrups" class="form-control form-control-sm" rows="3" onchange="updateSettings()"></textarea></div>
                        <div class="col-4"><small class="text-muted">–ú–æ–ª–æ–∫–æ</small><textarea id="set-milks" class="form-control form-control-sm" rows="3" onchange="updateSettings()"></textarea></div>
                        <div class="col-4"><small class="text-muted">–°–æ—É—Å—ã</small><textarea id="set-sauces" class="form-control form-control-sm" rows="3" onchange="updateSettings()"></textarea></div>
                    </div>
                </div>
                <input type="text" id="search" class="form-control" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –º–µ–Ω—é..." oninput="renderList()">
            </div>
            <div id="menu-list" class="card card-shadow p-0 overflow-hidden"></div>
        </div>

        <!-- 2. –ó–ê–ö–ê–ó–´ -->
        <div class="tab-pane fade" id="tab-orders">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="m-0">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h5>
                <button class="btn btn-light border btn-sm" onclick="loadOrders()"><i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div id="orders-container"></div>
        </div>

        <!-- 3. –ö–õ–ò–ï–ù–¢–´ -->
        <div class="tab-pane fade" id="tab-users">
            <div class="d-flex justify-content-between mb-3 align-items-center">
                <h5 class="m-0">–ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                <button class="btn btn-light border btn-sm" onclick="loadUsers()"><i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div class="input-group mb-3 card-shadow">
                <span class="input-group-text bg-white border-0"><i class="fas fa-search"></i></span>
                <input type="text" id="user-search" class="form-control border-0" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." oninput="filterUsers()">
            </div>
            <div id="users-container"></div>
        </div>

        <!-- 4. –ü–†–û–ú–û–ö–û–î–´ -->
        <div class="tab-pane fade" id="tab-promos">
            <div class="row">
                <div class="col-md-4">
                    <div class="card card-shadow p-3 mb-3">
                        <h6 class="fw-bold mb-3">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h6>
                        <input type="text" id="new-promo-code" class="form-control mb-2 text-uppercase fw-bold" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä. SUMMER)">
                        <div class="row g-2 mb-2">
                            <div class="col-6"><input type="number" id="new-promo-disc" class="form-control" placeholder="–°–∫–∏–¥–∫–∞ %"></div>
                            <div class="col-6"><input type="number" id="new-promo-limit" class="form-control" placeholder="–õ–∏–º–∏—Ç (—à—Ç)"></div>
                        </div>
                        <button class="btn btn-success w-100 fw-bold" onclick="addPromo()">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div id="promos-container"></div>
                </div>
            </div>
        </div>

        <!-- 5. –û–¢–ó–´–í–´ -->
        <div class="tab-pane fade" id="tab-reviews">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="m-0">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                <button class="btn btn-light border btn-sm" onclick="loadReviews()"><i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div id="reviews-container"></div>
        </div>
    </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –¢–û–í–ê–†–ê -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
          <input type="hidden" id="edit-id">
          <div class="row">
              <div class="col-md-4 border-end">
                  <label class="small text-muted fw-bold">–ò–ù–§–û–†–ú–ê–¶–ò–Ø</label>
                  <input type="text" id="edit-name" class="form-control mb-2 fw-bold" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                  <div class="row g-2 mb-2">
                      <div class="col-6"><input type="number" id="edit-price" class="form-control" placeholder="–¶–µ–Ω–∞"></div>
                      <div class="col-6 pt-2"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="edit-available"><label class="form-check-label">–í –Ω–∞–ª–∏—á–∏–∏</label></div></div>
                  </div>
                  <textarea id="edit-desc" class="form-control mb-2" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                  <input type="text" id="edit-badge" class="form-control" placeholder="–ë–µ–π–¥–∂ (–•–ò–¢)">
              </div>
              <div class="col-md-4 border-end">
                  <div class="d-flex justify-content-between mb-2 align-items-center">
                      <label class="small text-muted fw-bold">–û–ë–™–ï–ú–´</label>
                      <button class="btn btn-sm btn-success py-0 px-2" onclick="addVolumeRow()">+</button>
                  </div>
                  <div id="volumes-container"></div>
              </div>
              <div class="col-md-4">
                  <label class="small text-muted fw-bold mb-2">–ú–û–î–ò–§–ò–ö–ê–¢–û–†–´</label>
                  <div id="modifiers-container" style="max-height: 400px; overflow-y: auto;"></div>
              </div>
          </div>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-light" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-success fw-bold px-4" onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, doc, updateDoc, onSnapshot, getDocs, addDoc, deleteDoc, query, orderBy, limit, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // üî¥üî¥üî¥ –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –ö–û–ù–§–ò–ì –ò–ó FIREBASE CONSOLE üî¥üî¥üî¥
  const firebaseConfig = {
  apiKey: "AIzaSyCjmU7YTy6aKzd-0GxnS7DSClLmIFCVrWU",
  authDomain: "coffeemolldb.firebaseapp.com",
  projectId: "coffeemolldb",
  storageBucket: "coffeemolldb.firebasestorage.app",
  messagingSenderId: "599284136702",
  appId: "1:599284136702:web:d84ef0a10a1dde699743af",
  measurementId: "G-W4CDJ2PDX0"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  let menuData = [];
  let allUsers = [];

  const MOD_CONFIG = [
      { key: 'milk', label: '–ú–æ–ª–æ–∫–æ', def: 50 }, { key: 'alt_milk', label: '–ê–ª—å—Ç. –º–æ–ª–æ–∫–æ', def: 400 },
      { key: 'cream', label: '–°–ª–∏–≤–∫–∏', def: 50 }, { key: 'syrup', label: '–°–∏—Ä–æ–ø', def: 0 },
      { key: 'sugar', label: '–°–∞—Ö–∞—Ä', def: 0 }, { key: 'honey', label: '–ú–µ–¥', def: 100 },
      { key: 'lemon', label: '–õ–∏–º–æ–Ω', def: 50 }, { key: 'cinnamon', label: '–ö–æ—Ä–∏—Ü–∞', def: 0 },
      { key: 'shot', label: '–î–æ–ø. —à–æ—Ç', def: 300 }, { key: 'egg', label: '–Ø–π—Ü–æ', def: 70 },
      { key: 'cheese', label: '–°—ã—Ä', def: 150 }, { key: 'jalapeno', label: '–•–∞–ª–∞–ø–µ–Ω—å–æ', def: 150 },
      { key: 'onion', label: '–õ—É–∫ —Ñ—Ä–∏', def: 150 }, { key: 'sauce', label: '–°–æ—É—Å', def: 150 }
  ];

  window.login = () => {
      const e = document.getElementById('email').value;
      const p = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, e, p).catch(err => alert("–û—à–∏–±–∫–∞: " + err.message));
  }
  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
      document.getElementById('login-screen').style.display = user ? 'none' : 'block';
      document.getElementById('dashboard').style.display = user ? 'block' : 'none';
      if(user) { 
          initData(); 
          initSettings();
          // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          loadOrders();
          loadPromos(); 
          loadReviews();
      }
  });

  // === 1. –ú–ï–ù–Æ ===
  function initData() {
      onSnapshot(collection(db, "menu"), (s) => {
          menuData = []; s.forEach(d => menuData.push({ _id: d.id, ...d.data() }));
          renderList();
      });
  }
  function initSettings() {
      onSnapshot(doc(db, "settings", "main"), (d) => {
          if(!d.exists()) return;
          const data = d.data();
          document.getElementById('open-time').value = data.open_time || "09:00";
          document.getElementById('close-time').value = data.close_time || "23:00";
          document.getElementById('promo-switch').checked = (String(data.enable_promos) === "true");
          document.getElementById('set-syrups').value = data.syrup_names || "";
          document.getElementById('set-milks').value = data.alt_milks || "";
          document.getElementById('set-sauces').value = data.sauce_names || "";
      });
  }
  window.updateSettings = async () => {
      await updateDoc(doc(db, "settings", "main"), {
          open_time: document.getElementById('open-time').value,
          close_time: document.getElementById('close-time').value,
          enable_promos: String(document.getElementById('promo-switch').checked),
          syrup_names: document.getElementById('set-syrups').value,
          alt_milks: document.getElementById('set-milks').value,
          sauce_names: document.getElementById('set-sauces').value
      });
  }
  window.renderList = () => {
      const q = document.getElementById('search').value.toLowerCase();
      const cont = document.getElementById('menu-list'); cont.innerHTML = '';
      const cats = {};
      const order = ["–ò–ó–ë–†–ê–ù–ù–û–ï", "–ü–û–ü–£–õ–Ø–†–ù–û–ï", "–°–ï–ó–û–ù–ù–û–ï", "–ö–û–§–ï", "–ß–ê–ô", "–î–ï–°–ï–†–¢–´", "–•–û–õ–û–î–ù–´–ï –ù–ê–ü–ò–¢–ö–ò", "–ú–û–õ–û–ß–ù–´–ï –ö–û–ö–¢–ï–ô–õ–ò", "–ó–ê–í–¢–†–ê–ö–ò", "–ö–†–£–ê–°–°–ê–ù–´", "–•–û–¢-–î–û–ì–ò", "–°–ê–õ–ê–¢–´", "–ü–ò–¶–¶–ê", "–ü–ê–°–¢–´", "–ó–ê–ö–£–°–ö–ò"];
      
      menuData.forEach(i => { if(i.name.toLowerCase().includes(q)) { if(!cats[i.category]) cats[i.category]=[]; cats[i.category].push(i); } });
      const sorted = Object.keys(cats).sort((a,b) => { let ia = order.indexOf(a.toUpperCase()), ib = order.indexOf(b.toUpperCase()); return (ia===-1?999:ia) - (ib===-1?999:ib); });

      sorted.forEach(c => {
          cont.innerHTML += `<div class="p-2 bg-light fw-bold small text-uppercase text-muted border-bottom">${c}</div>`;
          cats[c].forEach(i => {
              const pr = (i.volumes && i.volumes.length) ? `–æ—Ç ${i.volumes[0].p} ‚Ç∏` : `${i.price} ‚Ç∏`;
              const statusColor = i.available ? '#88d100' : '#dc3545';
              cont.innerHTML += `
              <div class="item-row bg-white">
                  <div class="d-flex align-items-center">
                      <span style="background:${statusColor}" class="status-dot"></span>
                      <div><div class="fw-bold">${i.name}</div><div class="small text-muted">${pr}</div></div>
                  </div>
                  <button class="btn btn-sm btn-outline-dark border-0" onclick="openEdit('${i._id}')"><i class="fas fa-pen"></i></button>
              </div>`;
          });
      });
  }

  // === –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ===
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  window.openEdit = (id) => {
      const i = menuData.find(x => x._id === id);
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-name').value = i.name;
      document.getElementById('edit-price').value = i.price || 0;
      document.getElementById('edit-desc').value = i.description || "";
      document.getElementById('edit-badge').value = i.badge || "";
      document.getElementById('edit-available').checked = i.available;
      
      const mc = document.getElementById('modifiers-container'); mc.innerHTML = '';
      const cm = i.modifiers || {};
      MOD_CONFIG.forEach(c => {
          const chk = c.key in cm;
          const pr = chk ? (Array.isArray(cm[c.key]) ? cm[c.key][0] : cm[c.key]) : c.def;
          mc.innerHTML += `<div class="mod-row"><div class="form-check mb-0"><input class="form-check-input mod-cb" type="checkbox" id="m_${c.key}" data-key="${c.key}" ${chk?'checked':''}><label class="form-check-label small" for="m_${c.key}">${c.label}</label></div><input type="number" class="form-control form-control-sm mod-price-inp" id="mp_${c.key}" value="${pr}"></div>`;
      });
      document.getElementById('volumes-container').innerHTML = '';
      (i.volumes || []).forEach(v => addVolumeRow(v.n, v.p));
      modal.show();
  }
  window.addVolumeRow = (n='', p='') => {
      document.getElementById('volumes-container').insertAdjacentHTML('beforeend', `<div class="d-flex gap-2 mb-2 vol-row"><input type="text" class="form-control form-control-sm" placeholder="0.3" value="${n}"><input type="number" class="form-control form-control-sm" placeholder="–¶–µ–Ω–∞" value="${p}"><button class="btn btn-sm text-danger border-0" onclick="this.parentElement.remove()">‚úï</button></div>`);
  }
  window.saveItem = async () => {
      const id = document.getElementById('edit-id').value;
      const mods = {}; 
      document.querySelectorAll('.mod-cb').forEach(cb => { if(cb.checked) mods[cb.dataset.key] = parseInt(document.getElementById(`mp_${cb.dataset.key}`).value) || 0; });
      const vols = [];
      document.querySelectorAll('.vol-row').forEach(r => { const i = r.querySelectorAll('input'); if(i[0].value) vols.push({n: i[0].value, p: parseInt(i[1].value)||0}); });
      
      await updateDoc(doc(db, "menu", id), {
          name: document.getElementById('edit-name').value,
          price: parseInt(document.getElementById('edit-price').value)||0,
          description: document.getElementById('edit-desc').value,
          badge: document.getElementById('edit-badge').value,
          available: document.getElementById('edit-available').checked,
          modifiers: mods, volumes: vols
      });
      modal.hide();
  }

  // === 2. –ó–ê–ö–ê–ó–´ (–£–õ–£–ß–®–ï–ù–û) ===
  window.loadOrders = async () => {
      const cont = document.getElementById('orders-container');
      cont.innerHTML = '<div class="text-center p-3 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';
      try {
          // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã (–±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –∏–Ω–¥–µ–∫—Å–∞)
          const q = query(collection(db, "orders"), limit(50));
          const snap = await getDocs(q);
          
          if(snap.empty) { cont.innerHTML = '<div class="text-center text-muted p-4">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞</div>'; return; }

          let orders = [];
          snap.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
          orders.sort((a, b) => {
              const ta = (a.created_at || a.timestamp || a.date)?.seconds || 0;
              const tb = (b.created_at || b.timestamp || b.date)?.seconds || 0;
              return tb - ta;
          });

          cont.innerHTML = '';
          orders.forEach(d => {
              // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–µ–π
              let dateStr = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
              const rawDate = d.created_at || d.timestamp || d.date;
              if (rawDate && rawDate.seconds) {
                  dateStr = new Date(rawDate.seconds * 1000).toLocaleString('ru-RU');
              } else if (rawDate && typeof rawDate === 'string') {
                  dateStr = rawDate;
              }

              // –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
              let items = '<span class="text-muted">–ü—É—Å—Ç–æ–π –∑–∞–∫–∞–∑</span>';
              if (d.cart && Array.isArray(d.cart) && d.cart.length > 0) {
                  items = d.cart.map(i => `<span class="badge bg-light text-dark border me-1">${i.name} <span class="text-secondary">x${i.qty}</span></span>`).join('');
              }

              // –ò–Ω—Ñ–æ –æ –∫–ª–∏–µ–Ω—Ç–µ
              const info = d.info || {};
              
              cont.innerHTML += `
              <div class="card card-shadow order-card p-3 mb-3">
                  <div class="d-flex justify-content-between small text-muted mb-2">
                      <span><i class="far fa-clock"></i> ${dateStr}</span>
                      <span class="badge bg-light text-dark border">${d.status || '–ù–æ–≤—ã–π'}</span>
                  </div>
                  <div class="d-flex justify-content-between">
                      <div>
                          <div class="fw-bold">${info.name || '–ö–ª–∏–µ–Ω—Ç'} <small class="text-muted fw-normal">${info.phone || ''}</small></div>
                          <div class="small text-muted mb-2">${info.deliveryType || '–°–∞–º–æ–≤—ã–≤–æ–∑'} ‚Ä¢ ${info.paymentType || '–û–ø–ª–∞—Ç–∞'}</div>
                      </div>
                      <div class="fs-5 fw-bold text-success">${d.total || 0} ‚Ç∏</div>
                  </div>
                  <div class="mb-2">${items}</div>
                  ${info.address ? `<div class="small text-muted bg-light p-1 rounded"><i class="fas fa-map-marker-alt"></i> ${info.address}</div>` : ''}
                  ${info.comment ? `<div class="small text-danger mt-1">"${info.comment}"</div>` : ''}
              </div>`;
          });
      } catch (e) {
          console.error("Orders Error:", e);
          cont.innerHTML = `<div class="alert alert-warning small">–û—à–∏–±–∫–∞: ${e.message}.<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</div>`;
      }
  }

  // === 3. –ö–õ–ò–ï–ù–¢–´ ===
  window.loadUsers = async () => {
      const cont = document.getElementById('users-container');
      cont.innerHTML = '<div class="text-center p-3 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</div>';
      try {
          const snap = await getDocs(collection(db, "users"));
          allUsers = [];
          snap.forEach(doc => allUsers.push({id: doc.id, ...doc.data()}));
          
          allUsers.sort((a,b) => (b.total_spent || 0) - (a.total_spent || 0));
          filterUsers();
      } catch(e) {
          cont.innerHTML = '<div class="alert alert-danger small">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users</div>';
      }
  }

  window.filterUsers = () => {
      const q = document.getElementById('user-search').value.toLowerCase();
      const cont = document.getElementById('users-container');
      cont.innerHTML = '';
      
      const filtered = allUsers.filter(u => 
          (u.username && u.username.toLowerCase().includes(q)) || 
          (u.phone && u.phone.includes(q)) ||
          (u.first_name && u.first_name.toLowerCase().includes(q))
      ).slice(0, 50);

      if(filtered.length === 0) { cont.innerHTML = '<div class="text-center text-muted p-3">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }

      filtered.forEach(u => {
          const name = u.username || u.first_name || "–ö–ª–∏–µ–Ω—Ç";
          const initial = name[0].toUpperCase();
          const spent = u.total_spent || 0;
          const points = u.bonus_points || 0;
          
          cont.innerHTML += `
          <div class="card card-shadow p-3 mb-2">
              <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                      <div class="user-avatar">${initial}</div>
                      <div>
                          <div class="fw-bold">${name}</div>
                          <div class="small text-muted">${u.phone || '–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}</div>
                      </div>
                  </div>
                  <div class="text-end">
                      <div class="fw-bold text-success">${spent.toLocaleString()} ‚Ç∏</div>
                      <div class="small text-muted cursor-pointer text-decoration-underline" onclick="editPoints('${u.id}', ${points})">–ë–∞–ª–ª—ã: ${points}</div>
                  </div>
              </div>
          </div>`;
      });
  }

  window.editPoints = async (uid, current) => {
      const newVal = prompt("–ë–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤:", current);
      if(newVal !== null && !isNaN(parseInt(newVal))) {
          await updateDoc(doc(db, "users", uid), { bonus_points: parseInt(newVal) });
          loadUsers();
      }
  }

  // === 4. –ü–†–û–ú–û–ö–û–î–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û) ===
  window.loadPromos = async () => {
      const cont = document.getElementById('promos-container');
      cont.innerHTML = '<div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      try {
          const snap = await getDocs(collection(db, "promocodes"));
          cont.innerHTML = '';
          
          if(snap.empty) { cont.innerHTML = '<div class="text-muted p-3">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø—É—Å—Ç</div>'; return; }
          
          snap.forEach(d => {
              const p = d.data();
              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Å—Å–∏–≤–∞ users_used (–æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å undefined)
              const usedCount = (p.users_used && Array.isArray(p.users_used)) ? p.users_used.length : 0;
              const limitStr = p.limit ? ` –∏–∑ ${p.limit}` : '';
              
              cont.innerHTML += `
              <div class="card card-shadow p-3 mb-2 d-flex flex-row justify-content-between align-items-center">
                  <div>
                      <span class="promo-code">${p.code}</span>
                      <span class="badge bg-success ms-2">-${p.discount}%</span>
                      <div class="small text-muted mt-1">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <b>${usedCount}</b>${limitStr}</div>
                  </div>
                  <button class="btn btn-sm btn-outline-danger" onclick="delPromo('${d.id}')"><i class="fas fa-trash"></i></button>
              </div>`;
          });
      } catch(e) {
          console.error(e);
          cont.innerHTML = '<div class="alert alert-danger small">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>';
      }
  }

  window.addPromo = async () => {
      const code = document.getElementById('new-promo-code').value.toUpperCase().trim();
      const disc = parseInt(document.getElementById('new-promo-disc').value);
      const limitVal = parseInt(document.getElementById('new-promo-limit').value) || 100;
      
      if(!code || !disc) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ —Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏");
      
      await addDoc(collection(db, "promocodes"), {
          code: code,
          discount: disc,
          limit: limitVal,
          users_used: [], // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
          created_at: new Date()
      });
      
      document.getElementById('new-promo-code').value = '';
      loadPromos();
  }

  window.delPromo = async (id) => {
      if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥?")) {
          await deleteDoc(doc(db, "promocodes", id));
          loadPromos();
      }
  }

  // === 5. –û–¢–ó–´–í–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û) ===
  window.loadReviews = async () => {
      const cont = document.getElementById('reviews-container');
      cont.innerHTML = '<div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</div>';
      try {
          // –ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
          const q = query(collection(db, "reviews"), limit(50));
          const snap = await getDocs(q);
          
          if(snap.empty) { cont.innerHTML = '<div class="text-center text-muted p-4">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
          
          let reviews = [];
          snap.forEach(d => reviews.push({ id: d.id, ...d.data() }));
          
          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ JS
          reviews.sort((a,b) => {
             const da = a.created_at || a.date;
             const db = b.created_at || b.date;
             const ta = da?.seconds || 0;
             const tb = db?.seconds || 0;
             return tb - ta;
          });

          cont.innerHTML = '';
          reviews.forEach(r => {
              // –ò—â–µ–º –ø–æ–ª–µ –¥–∞—Ç—ã
              let dateStr = "";
              const rawDate = r.created_at || r.date || r.timestamp;
              if (rawDate && rawDate.seconds) dateStr = new Date(rawDate.seconds * 1000).toLocaleDateString();

              // –ò—â–µ–º —Ç–µ–∫—Å—Ç –∏ —Ä–µ–π—Ç–∏–Ω–≥
              const text = r.text || r.comment || r.review || '–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞';
              const rating = r.rating || r.stars || 5;
              const user = r.user_name || r.username || `ID: ${r.user_id}`;
              const starsHtml = '<i class="fas fa-star text-warning"></i>'.repeat(rating) + '<i class="far fa-star text-warning"></i>'.repeat(5 - rating);
              
              cont.innerHTML += `
              <div class="card card-shadow p-3 mb-2">
                  <div class="d-flex justify-content-between mb-2">
                      <span class="fw-bold small">${user}</span>
                      <span class="text-muted small">${dateStr}</span>
                  </div>
                  <div class="mb-2">${starsHtml}</div>
                  <p class="mb-0 text-secondary small">${text}</p>
              </div>`;
          });
      } catch (e) {
          console.error("Reviews Error:", e);
          cont.innerHTML = `<div class="alert alert-warning small">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤: ${e.message}</div>`;
      }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π
  window.loadOrders = window.loadOrders;
  window.loadUsers = window.loadUsers;
  window.filterUsers = window.filterUsers;
  window.editPoints = window.editPoints;
  window.loadPromos = window.loadPromos;
  window.addPromo = window.addPromo;
  window.delPromo = window.delPromo;
  window.loadReviews = window.loadReviews;

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
