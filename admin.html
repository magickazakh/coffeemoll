<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoffeeMoll Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SUPABASE JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            background: #f4f6f9;
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .login-container {
            max-width: 400px;
            margin: 80px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            display: none;
            padding: 0 15px;
        }

        .nav-pills .nav-link {
            color: #495057;
            margin-right: 5px;
            border-radius: 8px;
            font-weight: 500;
            transition: 0.2s;
        }

        .nav-pills .nav-link.active {
            background-color: #212529;
            color: #88d100;
        }

        .nav-pills .nav-link:hover {
            background-color: #e9ecef;
        }

        .card-shadow {
            background: white;
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            margin-bottom: 20px;
        }

        .item-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: 0.1s;
            background: white;
        }

        .item-row:hover {
            background: #f8f9fa;
        }

        .item-img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: #eee;
            margin-right: 15px;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .status-available {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-unavailable {
            background: #f8d7da;
            color: #842029;
        }

        .status-popular {
            background: #fff3cd;
            color: #856404;
            margin-left: 5px;
        }

        .promo-code {
            font-family: monospace;
            font-size: 1.1em;
            letter-spacing: 1px;
            background: #f1f3f5;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }

        .order-card {
            border-left: 4px solid #88d100;
            transition: transform 0.2s;
        }

        .order-card:hover {
            transform: translateY(-2px);
        }

        .modal-header {
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .preview-img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
        }

        .mod-price-inp {
            font-family: monospace;
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body>

    <!-- –í–•–û–î -->
    <div class="container" id="login-screen">
        <div class="login-container text-center">
            <h3 class="mb-4 fw-bold">‚òï CoffeeMoll <span style="color:#88d100">Admin</span></h3>
            <input type="email" id="email" class="form-control mb-3" placeholder="Email">
            <input type="password" id="password" class="form-control mb-3" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()" class="btn btn-dark w-100 py-2 fw-bold">–í–æ–π—Ç–∏</button>
            <div class="mt-3 text-muted small">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Supabase Auth</div>
        </div>
    </div>

    <!-- –ü–ê–ù–ï–õ–¨ -->
    <div class="main-container" id="dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="m-0 fw-bold">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-light text-dark border" id="admin-email"></span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i>
                    –í—ã–π—Ç–∏</button>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <ul class="nav nav-pills mb-4" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-menu"><i
                        class="fas fa-coffee"></i> –ú–µ–Ω—é</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-orders"
                    onclick="loadOrders()"><i class="fas fa-list-ul"></i> –ó–∞–∫–∞–∑—ã</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-promos"
                    onclick="loadPromos()"><i class="fas fa-ticket-alt"></i> –ü—Ä–æ–º–æ–∫–æ–¥—ã</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reviews"
                    onclick="loadReviews()"><i class="fas fa-star"></i> –û—Ç–∑—ã–≤—ã</button></li>
        </ul>

        <div class="tab-content">
            <!-- 1. –ú–ï–ù–Æ -->
            <div class="tab-pane fade show active" id="tab-menu">
                <div class="card card-shadow p-4">
                    <div class="row g-3 align-items-end mb-4">
                        <div class="col-md-3">
                            <label class="small text-muted fw-bold">–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input" type="checkbox" id="promo-switch"
                                    onchange="updateSettings()">
                                <label class="form-check-label">–í–∫–ª—é—á–∏—Ç—å –ü—Ä–æ–º–æ–∫–æ–¥—ã</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted fw-bold">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</label>
                            <div class="input-group input-group-sm mt-1">
                                <span class="input-group-text">C</span>
                                <input type="time" class="form-control" id="open-time" onchange="updateSettings()">
                                <span class="input-group-text">–î–æ</span>
                                <input type="time" class="form-control" id="close-time" onchange="updateSettings()">
                            </div>
                        </div>
                        <div class="col-md-5 text-end">
                            <button class="btn btn-light border me-2" type="button" data-bs-toggle="collapse"
                                data-bs-target="#settingsCollapse">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ø–∏—Å–∫–∏</button>
                        </div>
                    </div>

                    <div class="collapse mb-4" id="settingsCollapse">
                        <div class="card card-body bg-light border-0">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-1">–°–∏—Ä–æ–ø—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                                    <textarea id="set-syrups" class="form-control form-control-sm" rows="4"
                                        onchange="updateSettings()"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –º–æ–ª–æ–∫–æ</label>
                                    <textarea id="set-milks" class="form-control form-control-sm" rows="4"
                                        onchange="updateSettings()"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-1">–°–æ—É—Å—ã</label>
                                    <textarea id="set-sauces" class="form-control form-control-sm" rows="4"
                                        onchange="updateSettings()"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i
                                class="fas fa-search text-muted"></i></span>
                        <input type="text" id="search" class="form-control border-start-0" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥–∞..."
                            oninput="renderList()">
                    </div>
                </div>

                <div id="menu-list" class="card card-shadow p-0 overflow-hidden"></div>
            </div>

            <!-- 2. –ó–ê–ö–ê–ó–´ -->
            <div class="tab-pane fade" id="tab-orders">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 fw-bold">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h5>
                    <button class="btn btn-light border btn-sm shadow-sm" onclick="loadOrders()"><i
                            class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="orders-container"></div>
            </div>

            <!-- 3. –ü–†–û–ú–û–ö–û–î–´ -->
            <div class="tab-pane fade" id="tab-promos">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card card-shadow p-4 h-100">
                            <h6 class="fw-bold mb-3"><i class="fas fa-plus-circle text-success"></i> –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                            </h6>
                            <div class="mb-3">
                                <label class="small text-muted">–ö–æ–¥ (–Ω–∞–ø—Ä. SUMMER)</label>
                                <input type="text" id="new-promo-code" class="form-control text-uppercase fw-bold">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="small text-muted">–°–∫–∏–¥–∫–∞ %</label>
                                    <input type="number" id="new-promo-disc" class="form-control" placeholder="20">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">–õ–∏–º–∏—Ç</label>
                                    <input type="number" id="new-promo-limit" class="form-control" placeholder="100">
                                </div>
                            </div>
                            <button class="btn btn-success w-100 fw-bold py-2" onclick="addPromo()">–°–æ–∑–¥–∞—Ç—å</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="promos-container"></div>
                    </div>
                </div>
            </div>

            <!-- 4. –û–¢–ó–´–í–´ -->
            <div class="tab-pane fade" id="tab-reviews">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 fw-bold">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                    <button class="btn btn-light border btn-sm shadow-sm" onclick="loadReviews()"><i
                            class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="reviews-container"></div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –¢–û–í–ê–†–ê -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <input type="hidden" id="edit-id">

                    <div class="row g-4">
                        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                        <div class="col-md-4">
                            <div class="card p-3 border-0 shadow-sm h-100">
                                <h6 class="text-muted fw-bold small mb-3">–û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø</h6>
                                <div class="mb-3">
                                    <img id="edit-img-preview" src="" class="preview-img mb-2"
                                        onerror="this.src='https://via.placeholder.com/300x200?text=–ù–µ—Ç+—Ñ–æ—Ç–æ'">
                                    <input type="text" id="edit-image" class="form-control form-control-sm"
                                        placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É..."
                                        oninput="document.getElementById('edit-img-preview').src = this.value">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <input type="text" id="edit-category" class="form-control fw-bold" list="cat-list">
                                    <datalist id="cat-list">
                                        <option value="–ö–û–§–ï">
                                        <option value="–ß–ê–ô">
                                        <option value="–î–ï–°–ï–†–¢–´">
                                        <option value="–°–ï–ó–û–ù–ù–û–ï">
                                        <option value="–•–û–õ–û–î–ù–´–ï –ù–ê–ü–ò–¢–ö–ò">
                                    </datalist>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" id="edit-name" class="form-control fw-bold">
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label small">–¶–µ–Ω–∞</label>
                                        <input type="number" id="edit-price" class="form-control">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">–ë–µ–π–¥–∂</label>
                                        <input type="text" id="edit-badge" class="form-control" placeholder="–•–ò–¢">
                                    </div>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="edit-available">
                                    <label class="form-check-label fw-bold text-success">–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="edit-popular">
                                    <label class="form-check-label fw-bold text-warning">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ (–•–∏—Ç)</label>
                                </div>
                            </div>
                        </div>

                        <!-- –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ -->
                        <div class="col-md-4">
                            <div class="card p-3 border-0 shadow-sm mb-3">
                                <h6 class="text-muted fw-bold small mb-3">–û–ü–ò–°–ê–ù–ò–ï</h6>
                                <div class="mb-2">
                                    <label class="small text-muted">–ö–æ—Ä–æ—Ç–∫–æ–µ (–≤ —Å–ø–∏—Å–∫–µ)</label>
                                    <textarea id="edit-desc" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="mb-0">
                                    <label class="small text-muted">–ü–æ–ª–Ω–æ–µ (–≤ –∫–∞—Ä—Ç–æ—á–∫–µ)</label>
                                    <textarea id="edit-full-desc" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="card p-3 border-0 shadow-sm">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted fw-bold small m-0">–û–ë–™–ï–ú–´ / –ü–û–†–¶–ò–ò</h6>
                                    <button class="btn btn-sm btn-success py-0 px-2 fw-bold"
                                        onclick="addVolumeRow()">+</button>
                                </div>
                                <div id="volumes-container"></div>
                            </div>
                        </div>

                        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                        <div class="col-md-4">
                            <div class="card p-3 border-0 shadow-sm h-100">
                                <h6 class="text-muted fw-bold small mb-3">–ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ (–¶–ï–ù–ê)</h6>
                                <div id="modifiers-container"
                                    style="max-height: 500px; overflow-y: auto; padding-right: 5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-top-0">
                    <button class="btn btn-light border" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-success fw-bold px-4" onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ò–°–¢–û–†–ò–ò –ü–†–û–ú–û -->
    <div class="modal fade" id="promoHistoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">–ò—Å—Ç–æ—Ä–∏—è: <span id="hist-promo-code" class="text-success"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="promo-history-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- BOOTSTRAP JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // üî¥üî¥üî¥ –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –ö–õ–Æ–ß–ò OT SUPABASE üî¥üî¥üî¥
        const SUPABASE_URL = "https://eupoogmtejlmbfpyofgj.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1cG9vZ210ZWpsbWJmcHlvZmdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5ODMxOTgsImV4cCI6MjA4MzU1OTE5OH0.QJpNXXSr4qxzm6PV5GUE-N9d6U403YPXTb-Aghh2Y3g";

        if (SUPABASE_URL === "YOUR_SUPABASE_URL") {
            alert("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ admin.html –∏ –≤—Å—Ç–∞–≤—å—Ç–µ SUPABASE_URL –∏ SUPABASE_ANON_KEY!");
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let menuData = [];

        const MOD_CONFIG = [
            { key: 'milk', label: '–ú–æ–ª–æ–∫–æ', def: 50 },
            { key: 'alt_milk', label: '–ê–ª—å—Ç. –º–æ–ª–æ–∫–æ', def: 400 },
            { key: 'cream', label: '–°–ª–∏–≤–∫–∏', def: 50 },
            { key: 'syrup', label: '–°–∏—Ä–æ–ø', def: 0 },
            { key: 'sugar', label: '–°–∞—Ö–∞—Ä', def: 0 },
            { key: 'honey', label: '–ú–µ–¥', def: 100 },
            { key: 'lemon', label: '–õ–∏–º–æ–Ω', def: 50 },
            { key: 'cinnamon', label: '–ö–æ—Ä–∏—Ü–∞', def: 0 },
            { key: 'shot', label: '–î–æ–ø. —à–æ—Ç', def: 300 },
            { key: 'egg', label: '–Ø–π—Ü–æ', def: 70 },
            { key: 'cheese', label: '–°—ã—Ä', def: 150 },
            { key: 'jalapeno', label: '–•–∞–ª–∞–ø–µ–Ω—å–æ', def: 150 },
            { key: 'onion', label: '–õ—É–∫ —Ñ—Ä–∏', def: 150 },
            { key: 'sauce', label: '–°–æ—É—Å', def: 150 }
        ];

        // === AUTH ===
        window.login = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) alert("–û—à–∏–±–∫–∞: " + error.message);
        }

        window.logout = async () => {
            await supabase.auth.signOut();
        }

        supabase.auth.onAuthStateChange((event, session) => {
            const user = session?.user;
            document.getElementById('login-screen').style.display = user ? 'none' : 'block';
            document.getElementById('dashboard').style.display = user ? 'block' : 'none';
            if (user) {
                document.getElementById('admin-email').innerText = user.email;
                initData(); initSettings(); loadOrders(); loadPromos(); loadReviews();
            }
        });

        // === 1. –ú–ï–ù–Æ ===
        function initData() {
            // Realtime subscription for Menu
            supabase
                .channel('menu_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'menu_items' }, () => {
                   fetchMenu();
                })
                .subscribe();
            
            fetchMenu();
        }

        async function fetchMenu() {
            const { data, error } = await supabase.from('menu_items').select('*');
            if(data) {
                menuData = data;
                renderList();
            }
        }

        function initSettings() {
             supabase.from('settings').select('*').eq('id', 'main').single().then(({data}) => {
                if(!data) return;
                document.getElementById('open-time').value = data.open_time || "09:00";
                document.getElementById('close-time').value = data.close_time || "23:00";
                document.getElementById('promo-switch').checked = (String(data.enable_promos) === "true");
                
                // Arrays to string
                document.getElementById('set-syrups').value = Array.isArray(data.syrup_names) ? data.syrup_names.join(',') : (data.syrup_names || "");
                document.getElementById('set-milks').value = Array.isArray(data.alt_milks) ? data.alt_milks.join(',') : (data.alt_milks || "");
                document.getElementById('set-sauces').value = Array.isArray(data.sauce_names) ? data.sauce_names.join(',') : (data.sauce_names || "");
             });
        }

        window.updateSettings = async () => {
            const updates = {
                open_time: document.getElementById('open-time').value,
                close_time: document.getElementById('close-time').value,
                enable_promos: document.getElementById('promo-switch').checked,
                syrup_names: document.getElementById('set-syrups').value.split(',').map(s=>s.trim()).filter(s=>s),
                alt_milks: document.getElementById('set-milks').value.split(',').map(s=>s.trim()).filter(s=>s),
                sauce_names: document.getElementById('set-sauces').value.split(',').map(s=>s.trim()).filter(s=>s)
            };
            await supabase.from('settings').update(updates).eq('id', 'main');
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞
        window.renderList = () => {
            const q = document.getElementById('search').value.toLowerCase();
            const cont = document.getElementById('menu-list'); cont.innerHTML = '';
            const cats = {};
            const order = ["–ò–ó–ë–†–ê–ù–ù–û–ï", "–ü–û–ü–£–õ–Ø–†–ù–û–ï", "–°–ï–ó–û–ù–ù–û–ï", "–ö–û–§–ï", "–ß–ê–ô", "–î–ï–°–ï–†–¢–´", "–•–û–õ–û–î–ù–´–ï –ù–ê–ü–ò–¢–ö–ò", "–ú–û–õ–û–ß–ù–´–ï –ö–û–ö–¢–ï–ô–õ–ò", "–ó–ê–í–¢–†–ê–ö–ò", "–ö–†–£–ê–°–°–ê–ù–´", "–•–û–¢-–î–û–ì–ò", "–°–ê–õ–ê–¢–´", "–ü–ò–¶–¶–ê", "–ü–ê–°–¢–´", "–ó–ê–ö–£–°–ö–ò"];

            menuData.forEach(i => { if ((i.name||"").toLowerCase().includes(q)) { if (!cats[i.category]) cats[i.category] = []; cats[i.category].push(i); } });
            const sorted = Object.keys(cats).sort((a, b) => { let ia = order.indexOf(a.toUpperCase()), ib = order.indexOf(b.toUpperCase()); return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib); });

            sorted.forEach(c => {
                cont.innerHTML += `<div class="p-2 bg-light fw-bold small text-uppercase text-muted border-bottom">${c}</div>`;
                cats[c].forEach(i => {
                    const vols = i.volumes || [];
                    const pr = (vols.length) ? `–æ—Ç ${vols[0].p} ‚Ç∏` : `${i.price} ‚Ç∏`;
                    const statusClass = i.available ? 'status-available' : 'status-unavailable';
                    const statusText = i.available ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ù–µ—Ç';
                    const popularBadge = i.popular ? '<span class="status-badge status-popular">üî• –•–ò–¢</span>' : '';
                    const imgUrl = i.image || '';

                    cont.innerHTML += `
              <div class="item-row">
                  <img src="${imgUrl}" class="item-img" onerror="this.style.background='#f0f0f0'">
                  <div style="flex:1">
                      <div class="fw-bold text-dark d-flex align-items-center">${i.name} ${popularBadge}</div>
                      <div class="small text-muted">${pr}</div>
                  </div>
                  <div class="text-end me-3">
                      <span class="status-badge ${statusClass}">${statusText}</span>
                  </div>
                  <button class="btn btn-sm btn-light border" onclick="openEdit('${i.id}')"><i class="fas fa-pen"></i></button>
              </div>`;
                });
            });
        }

        // === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ===
        const modal = new bootstrap.Modal(document.getElementById('editModal'));

        window.openEdit = (id) => {
            const i = menuData.find(x => x.id === id);
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = i.name || "";
            document.getElementById('edit-category').value = i.category || "";
            document.getElementById('edit-price').value = i.price || 0;
            document.getElementById('edit-image').value = i.image || "";
            document.getElementById('edit-img-preview').src = i.image || "";
            document.getElementById('edit-desc').value = i.description || "";
            document.getElementById('edit-full-desc').value = i.full_description || i.description || "";
            document.getElementById('edit-badge').value = i.badge || "";
            document.getElementById('edit-available').checked = i.available !== false;
            document.getElementById('edit-popular').checked = i.popular === true;

            const mc = document.getElementById('modifiers-container'); mc.innerHTML = '';
            const cm = i.modifiers || {};
            MOD_CONFIG.forEach(c => {
                const chk = c.key in cm;
                let pr = c.def;
                if (chk) {
                    const val = cm[c.key];
                    if (Array.isArray(val)) pr = val.join('|');
                    else pr = val;
                }
                mc.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-2 pb-1 border-bottom">
              <div class="form-check mb-0">
                  <input class="form-check-input mod-cb" type="checkbox" id="m_${c.key}" data-key="${c.key}" ${chk ? 'checked' : ''}>
                  <label class="form-check-label small" for="m_${c.key}">${c.label}</label>
              </div>
              <input type="text" class="form-control form-control-sm text-end mod-price-inp" style="width:100px" id="mp_${c.key}" value="${pr}" placeholder="–¶–µ–Ω–∞">
          </div>`;
            });

            document.getElementById('volumes-container').innerHTML = '';
            (i.volumes || []).forEach(v => addVolumeRow(v.n, v.p));
            modal.show();
        }

        window.addVolumeRow = (n = '', p = '') => {
            const div = document.createElement('div');
            div.className = 'd-flex gap-2 mb-2 vol-row';
            div.innerHTML = `
          <input type="text" class="form-control form-control-sm" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (0.3)" value="${n}">
          <input type="number" class="form-control form-control-sm" placeholder="–¶–µ–Ω–∞" value="${p}" style="width: 100px;">
          <button class="btn btn-sm text-danger border-0 px-2" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
      `;
            document.getElementById('volumes-container').appendChild(div);
        }

        window.saveItem = async () => {
            const id = document.getElementById('edit-id').value;
            const mods = {};
            document.querySelectorAll('.mod-cb').forEach(cb => {
                if (cb.checked) {
                    const rawVal = document.getElementById(`mp_${cb.dataset.key}`).value;
                    let val;
                    if (rawVal.includes('|')) val = rawVal.split('|').map(v => parseInt(v.trim()) || 0);
                    else val = parseInt(rawVal) || 0;
                    mods[cb.dataset.key] = val;
                }
            });

            const vols = [];
            document.querySelectorAll('.vol-row').forEach(r => {
                const inputs = r.querySelectorAll('input');
                if (inputs[0].value) vols.push({ n: inputs[0].value, p: parseInt(inputs[1].value) || 0 });
            });

            const updateData = {
                name: document.getElementById('edit-name').value,
                category: document.getElementById('edit-category').value,
                price: parseInt(document.getElementById('edit-price').value) || 0,
                image: document.getElementById('edit-image').value,
                description: document.getElementById('edit-desc').value,
                full_description: document.getElementById('edit-full-desc').value,
                badge: document.getElementById('edit-badge').value,
                available: document.getElementById('edit-available').checked,
                popular: document.getElementById('edit-popular').checked,
                modifiers: mods,
                volumes: vols
            };

            try {
                await supabase.from('menu_items').update(updateData).eq('id', id);
                modal.hide();
                fetchMenu();
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
            }
        }

        // === 2. –ó–ê–ö–ê–ó–´ ===
        let orderSub = null;
        window.loadOrders = async () => {
            const cont = document.getElementById('orders-container');
            cont.innerHTML = '<div class="text-center p-3 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

            // Initial Fetch
            const { data: orders, error } = await supabase.from('orders').select('*').order('created_at', {ascending: false}).limit(50);
            
            if (orders) renderOrders(orders);
            
            // Subscribe
            if(orderSub) supabase.removeChannel(orderSub);
            orderSub = supabase.channel('order_updates')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
                 // On any change, simple re-fetch for now to stay synced
                 loadOrders(); // Warning: loop potential if logging
            })
            .subscribe();
        }
        
        function renderOrders(orders) {
            const cont = document.getElementById('orders-container');
            cont.innerHTML = '';
            if (orders.length === 0) {
                 cont.innerHTML = '<div class="text-center text-muted p-4">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞</div>';
                 return;
            }
            
             const statusColors = {
                'new': 'bg-primary',
                'pending': 'bg-warning',
                'accepted': 'bg-info',
                'ready': 'bg-success',
                'given': 'bg-secondary',
                'rejected': 'bg-danger'
            };

            orders.forEach(d => {
                const info = d.info || {};
                const cart = d.cart || [];
                const total = d.total_price || 0;
                let dateStr = new Date(d.created_at).toLocaleString('ru-RU');
                const currentStatus = d.status || 'new';

                let itemsHtml = '';
                cart.forEach(i => {
                    let opts = (i.options || []).map(o => `‚Ä¢ ${o}`).join('<br>');
                    if (opts) opts = `<div class="small text-muted ps-3 mt-1" style="font-size:0.8em">${opts}</div>`;
                    itemsHtml += `<div class="border-bottom pb-2 mb-2"><div class="d-flex justify-content-between"><span>${i.name}</span><span class="badge bg-light text-dark border">x${i.qty}</span></div>${opts}</div>`;
                });

                cont.innerHTML += `
              <div class="card card-shadow order-card p-3 mb-3" style="border-left-color: ${currentStatus === 'new' ? '#007bff' : (currentStatus === 'rejected' ? '#dc3545' : '#88d100')}">
                  <div class="d-flex justify-content-between small text-muted mb-2">
                    <span>${dateStr}</span>
                    <span class="badge ${statusColors[currentStatus] || 'bg-secondary'}">${currentStatus.toUpperCase()}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                      <div class="fw-bold">${info.name || '–ö–ª–∏–µ–Ω—Ç'} <span class="fw-normal text-muted">${info.phone || ''}</span></div>
                      <div class="fs-5 fw-bold text-success">${total} ‚Ç∏</div>
                  </div>
                  <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="toggleOrder('${d.id}')">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤ (${cart.length})</button>
                  <div id="order-details-${d.id}" style="display:none" class="bg-light p-2 rounded small">
                      ${itemsHtml}
                      ${info.address ? `<div class="mt-2 border-top pt-2">üìç ${info.address}</div>` : ''}
                      ${info.comment ? `<div class="text-danger">üí¨ ${info.comment}</div>` : ''}
                      <div class="mt-2 pt-2 border-top d-flex gap-2">
                          <button class="btn btn-xs btn-outline-danger" onclick="updateOrderStatus('${d.id}', 'rejected')">–û—Ç–º–µ–Ω–∞</button>
                          <button class="btn btn-xs btn-outline-success" onclick="updateOrderStatus('${d.id}', 'ready')">–ì–æ—Ç–æ–≤</button>
                      </div>
                  </div>
              </div>`;
            });
        }

        window.updateOrderStatus = async (id, status) => {
             await supabase.from('orders').update({status: status}).eq('id', id);
             loadOrders();
        }

        window.toggleOrder = (id) => {
            const el = document.getElementById(`order-details-${id}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // === 3. –ü–†–û–ú–û–ö–û–î–´ ===
        window.loadPromos = async () => {
            const cont = document.getElementById('promos-container');
            const {data: promos} = await supabase.from('promocodes').select('*');
            cont.innerHTML = '';
            promos.forEach(d => {
                const disc = Math.round((d.discount || 0) * 100);
                cont.innerHTML += `
          <div class="card card-shadow p-3 mb-2 d-flex flex-row justify-content-between align-items-center">
              <div>
                  <span class="promo-code">${d.code}</span> <span class="badge bg-success">-${disc}%</span>
                  <div class="small text-muted mt-1">–û—Å—Ç–∞–ª–æ—Å—å: ${d.limit || 0}</div>
              </div>
              <div>
                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="showPromoHistory('${d.code}')"><i class="fas fa-history"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="delPromo('${d.code}')"><i class="fas fa-trash"></i></button>
              </div>
          </div>`;
            });
        }
        
        window.addPromo = async () => {
             const code = document.getElementById('new-promo-code').value.toUpperCase().trim();
             const limit = parseInt(document.getElementById('new-promo-limit').value);
             const discount = parseInt(document.getElementById('new-promo-disc').value) / 100;
             if(code && limit && discount) {
                 await supabase.from('promocodes').insert({code, limit, discount});
                 loadPromos();
             }
        }
        
        window.delPromo = async (code) => {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                await supabase.from('promocodes').delete().eq('code', code);
                loadPromos();
            }
        }

        // === –ò–°–¢–û–†–ò–Ø –ü–†–û–ú–û ===
        const historyModal = new bootstrap.Modal(document.getElementById('promoHistoryModal'));
        window.showPromoHistory = async (code) => {
            document.getElementById('hist-promo-code').innerText = code;
            const list = document.getElementById('promo-history-list'); list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            historyModal.show();
            
            const {data: history} = await supabase.from('promo_history').select('*').eq('code', code);
            list.innerHTML = '';
            if (!history || history.length===0) list.innerHTML = '<div class="text-muted small">–ü—É—Å—Ç–æ</div>';
            
            history.forEach(h => {
                let date = new Date(h.created_at).toLocaleString();
                list.innerHTML += `<div class="d-flex justify-content-between border-bottom py-2 small"><div><b>${h.user_id}</b><br><span class="text-muted">${date}</span></div></div>`;
            });
        }

        // === 4. –û–¢–ó–´–í–´ ===
        window.loadReviews = async () => {
            const cont = document.getElementById('reviews-container');
            cont.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            const { data: reviews } = await supabase.from('reviews').select('*').order('created_at', {ascending: false});
            cont.innerHTML = '';
            reviews.forEach(r => {
                 let date = new Date(r.created_at).toLocaleString();
                 cont.innerHTML += `
                 <div class="card card-shadow p-3 mb-2">
                    <div class="d-flex justify-content-between small text-muted"><span>${date}</span> <span>ID: ${r.user_id}</span></div>
                    <div class="fw-bold mt-1">${r.name || '–ê–Ω–æ–Ω–∏–º'}</div>
                    <div class="my-2">
                        –°–µ—Ä–≤–∏—Å: <b>${r.service_rate}</b> | –ï–¥–∞: <b>${r.food_rate}</b>
                    </div>
                    ${r.tips && r.tips !== '–ù–µ—Ç' ? `<div class="text-success small mb-2">üí∞ –ß–∞–µ–≤—ã–µ: ${r.tips}</div>` : ''}
                    <div class="bg-light p-2 rounded small">"${r.comment}"</div>
                 </div>
                 `;
            });
        }

    </script>
</body>

</html>
