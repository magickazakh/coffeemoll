<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoffeeMoll Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f4f6f9;
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .login-container {
            max-width: 400px;
            margin: 80px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            display: none;
            padding: 0 15px;
        }

        .nav-pills .nav-link {
            color: #495057;
            margin-right: 5px;
            border-radius: 8px;
            font-weight: 500;
            transition: 0.2s;
        }

        .nav-pills .nav-link.active {
            background-color: #212529;
            color: #88d100;
        }

        .nav-pills .nav-link:hover {
            background-color: #e9ecef;
        }

        .card-shadow {
            background: white;
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            margin-bottom: 20px;
        }

        .item-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: 0.1s;
            background: white;
        }

        .item-row:hover {
            background: #f8f9fa;
        }

        .item-img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: #eee;
            margin-right: 15px;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .status-available {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-unavailable {
            background: #f8d7da;
            color: #842029;
        }

        .status-popular {
            background: #fff3cd;
            color: #856404;
            margin-left: 5px;
        }

        .promo-code {
            font-family: monospace;
            font-size: 1.1em;
            letter-spacing: 1px;
            background: #f1f3f5;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }

        .order-card {
            border-left: 4px solid #88d100;
            transition: transform 0.2s;
        }

        .order-card:hover {
            transform: translateY(-2px);
        }

        .modal-header {
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .preview-img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è —Ü–µ–Ω—ã –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ */
        .mod-price-inp {
            font-family: monospace;
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body>

    <!-- –í–•–û–î -->
    <div class="container" id="login-screen">
        <div class="login-container text-center">
            <h3 class="mb-4 fw-bold">‚òï CoffeeMoll <span style="color:#88d100">Admin</span></h3>
            <input type="email" id="email" class="form-control mb-3" placeholder="Email">
            <input type="password" id="password" class="form-control mb-3" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()" class="btn btn-dark w-100 py-2 fw-bold">–í–æ–π—Ç–∏</button>
            <div id="login-error" class="text-danger mt-2 small" style="display:none;"></div>
        </div>
    </div>

    <!-- –ü–ê–ù–ï–õ–¨ -->
    <div class="main-container" id="dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="m-0 fw-bold">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-light text-dark border" id="admin-email"></span>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm"><i class="fas fa-sign-out-alt"></i>
                    –í—ã–π—Ç–∏</button>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <ul class="nav nav-pills mb-4" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-menu"><i
                        class="fas fa-coffee"></i> –ú–µ–Ω—é</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-orders"
                    onclick="loadOrders()"><i class="fas fa-list-ul"></i> –ó–∞–∫–∞–∑—ã</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-promos"
                    onclick="loadPromos()"><i class="fas fa-ticket-alt"></i> –ü—Ä–æ–º–æ–∫–æ–¥—ã</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reviews"
                    onclick="loadReviews()"><i class="fas fa-star"></i> –û—Ç–∑—ã–≤—ã</button></li>
        </ul>

        <div class="tab-content">

            <!-- 1. –ú–ï–ù–Æ -->
            <div class="tab-pane fade show active" id="tab-menu">
                <div class="card card-shadow p-4">
                    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button class="btn btn-success fw-bold px-4 py-2 shadow-sm" onclick="openAdd()">
                            <i class="fas fa-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ
                        </button>
                        
                        <button class="btn btn-light border" type="button" data-bs-toggle="collapse"
                            data-bs-target="#settingsCollapse">‚öôÔ∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>

                    <div class="collapse mb-4" id="settingsCollapse">
                        <div class="card card-body bg-light border-0">
                            <div class="row g-3 align-items-end mb-3">
                                <div class="col-md-3">
                                    <label class="small text-muted fw-bold">–û–±—â–∏–µ</label>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="promo-switch"
                                            onchange="updateSettings()">
                                        <label class="form-check-label">–í–∫–ª—é—á–∏—Ç—å –ü—Ä–æ–º–æ–∫–æ–¥—ã</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</label>
                                    <div class="input-group input-group-sm mt-1">
                                        <span class="input-group-text">C</span>
                                        <input type="time" class="form-control" id="open-time" onchange="updateSettings()">
                                        <span class="input-group-text">–î–æ</span>
                                        <input type="time" class="form-control" id="close-time" onchange="updateSettings()">
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-1">–°–∏—Ä–æ–ø—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                                    <textarea id="set-syrups" class="form-control form-control-sm" rows="4"
                                        onchange="updateSettings()"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-1">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –º–æ–ª–æ–∫–æ</label>
                                    <textarea id="set-milks" class="form-control form-control-sm" rows="4"
                                        onchange="updateSettings()"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold mb-1">–°–æ—É—Å—ã</label>
                                    <textarea id="set-sauces" class="form-control form-control-sm" rows="4"
                                        onchange="updateSettings()"></textarea>
                                </div>
                                <div class="col-12 mt-3">
                                    <label class="small fw-bold mb-1">–ü–æ—Ä—è–¥–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</label>
                                    <textarea id="set-categories" class="form-control form-control-sm" rows="2" placeholder="–ò–ó–ë–†–ê–ù–ù–û–ï, –ö–û–§–ï, –ß–ê–ô..." onchange="updateSettings(); renderList()"></textarea>
                                    <div class="form-text small">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏, –Ω–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∑–¥–µ—Å—å, –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–Ω—Ü–µ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i
                                class="fas fa-search text-muted"></i></span>
                        <input type="text" id="search" class="form-control border-start-0" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥–∞..."
                            oninput="renderList()">
                    </div>
                </div>

                <div id="menu-list" class="card card-shadow p-0 overflow-hidden"></div>
            </div>

            <!-- 2. –ó–ê–ö–ê–ó–´ -->
            <div class="tab-pane fade" id="tab-orders">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 fw-bold">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h5>
                    <button class="btn btn-light border btn-sm shadow-sm" onclick="loadOrders()"><i
                            class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="orders-container"></div>
            </div>

            <!-- 3. –ü–†–û–ú–û–ö–û–î–´ -->
            <div class="tab-pane fade" id="tab-promos">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card card-shadow p-4 h-100">
                            <h6 class="fw-bold mb-3"><i class="fas fa-plus-circle text-success"></i> –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                            </h6>
                            <div class="mb-3">
                                <label class="small text-muted">–ö–æ–¥ (–Ω–∞–ø—Ä. SUMMER)</label>
                                <input type="text" id="new-promo-code" class="form-control text-uppercase fw-bold">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="small text-muted">–°–∫–∏–¥–∫–∞ %</label>
                                    <input type="number" id="new-promo-disc" class="form-control" placeholder="20">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">–õ–∏–º–∏—Ç</label>
                                    <input type="number" id="new-promo-limit" class="form-control" placeholder="100">
                                </div>
                            </div>
                            <button class="btn btn-success w-100 fw-bold py-2" onclick="addPromo()">–°–æ–∑–¥–∞—Ç—å</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="promos-container"></div>
                    </div>
                </div>
            </div>

            <!-- 4. –û–¢–ó–´–í–´ -->
            <div class="tab-pane fade" id="tab-reviews">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 fw-bold">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                    <button class="btn btn-light border btn-sm shadow-sm" onclick="loadReviews()"><i
                            class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="reviews-container"></div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø/–î–û–ë–ê–í–õ–ï–ù–ò–Ø –¢–û–í–ê–†–ê -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <input type="hidden" id="edit-id">

                    <div class="row g-4">
                        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –û—Å–Ω–æ–≤–Ω–æ–µ -->
                        <div class="col-md-4">
                            <div class="card p-3 border-0 shadow-sm h-100">
                                <h6 class="text-muted fw-bold small mb-3">–û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø</h6>

                                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                                <div class="mb-3">
                                    <img id="edit-img-preview" src="" class="preview-img mb-2"
                                        onerror="this.src='data:image/svg+xml;charset=UTF-8,%3csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\' viewBox=\'0 0 300 200\'%3e%3crect width=\'300\' height=\'200\' fill=\'%23eee\'/%3e%3ctext x=\'50%25\' y=\'50%25\' font-family=\'Arial\' font-size=\'20\' fill=\'%23aaa\' dominant-baseline=\'middle\' text-anchor=\'middle\'%3e%D0%9D%D0%B5%D1%82+%D1%84%D0%BE%D1%82%D0%BE%3c/text%3e%3c/svg%3e'">
                                    <input type="text" id="edit-image" class="form-control form-control-sm"
                                        placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É..."
                                        oninput="document.getElementById('edit-img-preview').src = this.value">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                    <input type="text" id="edit-category" class="form-control fw-bold" list="cat-list" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é">
                                    <datalist id="cat-list">
                                        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
                                    </datalist>
                                    <div class="form-text small" style="font-size: 0.75rem;">–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –ø—Ä–æ—Å—Ç–æ –≤–ø–∏—à–∏—Ç–µ –µ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ.</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" id="edit-name" class="form-control fw-bold" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞">
                                </div>

                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label small">–¶–µ–Ω–∞</label>
                                        <input type="number" id="edit-price" class="form-control" placeholder="0">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">–ë–µ–π–¥–∂</label>
                                        <input type="text" id="edit-badge" class="form-control" placeholder="–•–ò–¢">
                                    </div>
                                </div>

                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="edit-available">
                                    <label class="form-check-label fw-bold text-success">–î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="edit-popular">
                                    <label class="form-check-label fw-bold text-warning">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ (–•–∏—Ç)</label>
                                </div>
                            </div>
                        </div>

                        <!-- –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞: –û–ø–∏—Å–∞–Ω–∏–µ –∏ –û–±—ä–µ–º—ã -->
                        <div class="col-md-4">
                            <div class="card p-3 border-0 shadow-sm mb-3">
                                <h6 class="text-muted fw-bold small mb-3">–û–ü–ò–°–ê–ù–ò–ï</h6>
                                <div class="mb-2">
                                    <label class="small text-muted">–ö–æ—Ä–æ—Ç–∫–æ–µ (–≤ —Å–ø–∏—Å–∫–µ)</label>
                                    <textarea id="edit-desc" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="mb-0">
                                    <label class="small text-muted">–ü–æ–ª–Ω–æ–µ (–≤ –∫–∞—Ä—Ç–æ—á–∫–µ)</label>
                                    <textarea id="edit-full-desc" class="form-control" rows="4"></textarea>
                                </div>
                            </div>

                            <div class="card p-3 border-0 shadow-sm">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted fw-bold small m-0">–û–ë–™–ï–ú–´ / –ü–û–†–¶–ò–ò</h6>
                                    <button class="btn btn-sm btn-success py-0 px-2 fw-bold"
                                        onclick="addVolumeRow()">+</button>
                                </div>
                                <div class="small text-muted fst-italic mb-2" style="font-size: 0.75rem;">–ï—Å–ª–∏ –∑–∞–¥–∞–Ω—ã
                                    –æ–±—ä–µ–º—ã, –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–Ω–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è</div>
                                <div id="volumes-container"></div>
                            </div>
                        </div>

                        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã -->
                        <div class="col-md-4">
                            <div class="card p-3 border-0 shadow-sm h-100">
                                <h6 class="text-muted fw-bold small mb-3">–ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ (–¶–ï–ù–ê)</h6>
                                <div class="small text-muted mb-2 fst-italic" style="font-size: 0.75rem;">
                                    –î–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–±—ä–µ–º–æ–≤ –ø–∏—à–∏—Ç–µ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ "|", –Ω–∞–ø—Ä–∏–º–µ—Ä: 300|400
                                </div>
                                <div id="modifiers-container"
                                    style="max-height: 500px; overflow-y: auto; padding-right: 5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-top-0">
                    <button class="btn btn-light border" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-success fw-bold px-4" onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ò–°–¢–û–†–ò–ò –ü–†–û–ú–û -->
    <div class="modal fade" id="promoHistoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">–ò—Å—Ç–æ—Ä–∏—è: <span id="hist-promo-code" class="text-success"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="promo-history-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, addDoc, onSnapshot, getDocs, setDoc, deleteDoc, query, orderBy, limit, where, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // üî¥üî¥üî¥ –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –ö–û–ù–§–ò–ì üî¥üî¥üî¥
        const firebaseConfig = {
            apiKey: "AIzaSyCjmU7YTy6aKzd-0GxnS7DSClLmIFCVrWU",
            authDomain: "coffeemolldb.firebaseapp.com",
            projectId: "coffeemolldb",
            storageBucket: "coffeemolldb.firebasestorage.app",
            messagingSenderId: "599284136702",
            appId: "1:599284136702:web:d84ef0a10a1dde699743af",
            measurementId: "G-W4CDJ2PDX0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let menuData = [];

        const MOD_CONFIG = [
            { key: 'milk', label: '–ú–æ–ª–æ–∫–æ', def: 50 },
            { key: 'alt_milk', label: '–ê–ª—å—Ç. –º–æ–ª–æ–∫–æ', def: 400 },
            { key: 'cream', label: '–°–ª–∏–≤–∫–∏', def: 50 },
            { key: 'syrup', label: '–°–∏—Ä–æ–ø', def: 0 },
            { key: 'sugar', label: '–°–∞—Ö–∞—Ä', def: 0 },
            { key: 'honey', label: '–ú–µ–¥', def: 100 },
            { key: 'lemon', label: '–õ–∏–º–æ–Ω', def: 50 },
            { key: 'cinnamon', label: '–ö–æ—Ä–∏—Ü–∞', def: 0 },
            { key: 'shot', label: '–î–æ–ø. —à–æ—Ç', def: 300 },
            { key: 'egg', label: '–Ø–π—Ü–æ', def: 70 },
            { key: 'cheese', label: '–°—ã—Ä', def: 150 },
            { key: 'jalapeno', label: '–•–∞–ª–∞–ø–µ–Ω—å–æ', def: 150 },
            { key: 'onion', label: '–õ—É–∫ —Ñ—Ä–∏', def: 150 },
            { key: 'sauce', label: '–°–æ—É—Å', def: 150 }
        ];

        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            const errDiv = document.getElementById('login-error');
            errDiv.style.display = 'none';
            
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                console.error("Login error:", err);
                errDiv.innerText = "–û—à–∏–±–∫–∞: " + err.message;
                errDiv.style.display = 'block';
            });
        }
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            document.getElementById('login-screen').style.display = user ? 'none' : 'block';
            document.getElementById('dashboard').style.display = user ? 'block' : 'none';
            if (user) {
                document.getElementById('admin-email').innerText = user.email;
                initData(); initSettings(); loadOrders(); loadPromos(); loadReviews();
            }
        });

        // === 1. –ú–ï–ù–Æ ===
        function initData() {
            onSnapshot(collection(db, "menu"), (s) => {
                menuData = []; s.forEach(d => menuData.push({ _id: d.id, ...d.data() }));
                renderList();
            }, (error) => {
                console.error("Menu fetch error:", error);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ú–µ–Ω—é: " + error.message);
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function initSettings() {
            onSnapshot(doc(db, "settings", "main"), (d) => {
                // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–¥–∏–º –¥–µ—Ñ–æ–ª—Ç –ª–æ–∫–∞–ª—å–Ω–æ —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å UI
                const data = d.exists() ? d.data() : {};
                
                document.getElementById('open-time').value = data.open_time || "09:00";
                document.getElementById('close-time').value = data.close_time || "23:00";
                document.getElementById('promo-switch').checked = (String(data.enable_promos) === "true");
                document.getElementById('set-syrups').value = data.syrup_names || "";
                document.getElementById('set-milks').value = data.alt_milks || "";
                document.getElementById('set-sauces').value = data.sauce_names || "";
                document.getElementById('set-categories').value = data.category_order || "";
                renderList(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å –Ω–æ–≤—ã–º –ø–æ—Ä—è–¥–∫–æ–º
            }, (error) => {
                console.error("Settings fetch error:", error);
            });
        }
        window.updateSettings = async () => {
            try {
                await setDoc(doc(db, "settings", "main"), { // –ò—Å–ø–æ–ª—å–∑—É–µ–º setDoc —Å merge –≤–º–µ—Å—Ç–æ updateDoc, –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç
                    open_time: document.getElementById('open-time').value,
                    close_time: document.getElementById('close-time').value,
                    enable_promos: String(document.getElementById('promo-switch').checked),
                    syrup_names: document.getElementById('set-syrups').value,
                    alt_milks: document.getElementById('set-milks').value,
                    sauce_names: document.getElementById('set-sauces').value,
                    category_order: document.getElementById('set-categories').value
                }, { merge: true });
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: " + e.message);
            }
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞
        window.renderList = () => {
            const q = document.getElementById('search').value.toLowerCase();
            const cont = document.getElementById('menu-list'); cont.innerHTML = '';
            const cats = {};
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ –∏–∑ –ø–æ–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
            const orderStr = document.getElementById('set-categories').value;
            let order = [];
            if (orderStr) {
                order = orderStr.split(',').map(s => s.trim().toUpperCase());
            } else {
                order = ["–ò–ó–ë–†–ê–ù–ù–û–ï", "–ü–û–ü–£–õ–Ø–†–ù–û–ï", "–°–ï–ó–û–ù–ù–û–ï", "–ö–û–§–ï", "–ß–ê–ô", "–î–ï–°–ï–†–¢–´", "–•–û–õ–û–î–ù–´–ï –ù–ê–ü–ò–¢–ö–ò", "–ú–û–õ–û–ß–ù–´–ï –ö–û–ö–¢–ï–ô–õ–ò", "–ó–ê–í–¢–†–ê–ö–ò", "–ö–†–£–ê–°–°–ê–ù–´", "–•–û–¢-–î–û–ì–ò", "–°–ê–õ–ê–¢–´", "–ü–ò–¶–¶–ê", "–ü–ê–°–¢–´", "–ó–ê–ö–£–°–ö–ò"];
            }

            // 1. –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            menuData.forEach(i => { 
                if (i.name.toLowerCase().includes(q)) { 
                    const catName = i.category ? i.category.trim().toUpperCase() : "–ü–†–û–ß–ï–ï";
                    if (!cats[catName]) cats[catName] = []; 
                    cats[catName].push(i); 
                } 
            });

            // 2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const sorted = Object.keys(cats).sort((a, b) => { 
                let ia = order.indexOf(a), ib = order.indexOf(b); 
                
                // –ï—Å–ª–∏ –æ–±–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (ia !== -1 && ib !== -1) return ia - ib;
                
                // –ï—Å–ª–∏ –æ–¥–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ, –æ–Ω–∞ –≤—ã—à–µ
                if (ia !== -1) return -1;
                if (ib !== -1) return 1;
                
                // –ï—Å–ª–∏ –æ–±–µ–∏—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ - –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
                return a.localeCompare(b);
            });

            sorted.forEach(c => {
                cont.innerHTML += `<div class="p-2 bg-light fw-bold small text-uppercase text-muted border-bottom">${c}</div>`;
                cats[c].forEach(i => {
                    const pr = (i.volumes && i.volumes.length) ? `–æ—Ç ${i.volumes[0].p} ‚Ç∏` : `${i.price} ‚Ç∏`;
                    const statusClass = i.available ? 'status-available' : 'status-unavailable';
                    const statusText = i.available ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ù–µ—Ç';
                    const popularBadge = i.popular ? '<span class="status-badge status-popular">üî• –•–ò–¢</span>' : '';
                    const imgUrl = i.image || '';
                    
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞ data:uri)
                    const fallbackImg = "data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'%3e%3crect width='50' height='50' fill='%23f0f0f0'/%3e%3c/svg%3e";

                    cont.innerHTML += `
              <div class="item-row">
                  <img src="${imgUrl}" class="item-img" onerror="this.src='${fallbackImg}'">
                  <div style="flex:1">
                      <div class="fw-bold text-dark d-flex align-items-center">${i.name} ${popularBadge}</div>
                      <div class="small text-muted">${pr}</div>
                  </div>
                  <div class="text-end me-3">
                      <span class="status-badge ${statusClass}">${statusText}</span>
                  </div>
                  <button class="btn btn-sm btn-light border" onclick="openEdit('${i._id}')"><i class="fas fa-pen"></i></button>
              </div>`;
                });
            });
        }

        // === –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï / –î–û–ë–ê–í–õ–ï–ù–ò–ï ===
        const modal = new bootstrap.Modal(document.getElementById('editModal'));

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function populateCategoryList() {
            const list = document.getElementById('cat-list');
            list.innerHTML = '';
            // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            const uniqueCats = [...new Set(menuData.map(i => i.category ? i.category.toUpperCase() : ""))].filter(c => c);
            uniqueCats.sort().forEach(c => {
                list.innerHTML += `<option value="${c}">`;
            });
        }

        // –û–¢–ö–†–´–¢–ò–ï –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø (–ù–û–í–û–ï)
        window.openAdd = () => {
            document.getElementById('modalTitle').innerText = "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞";
            document.getElementById('edit-id').value = ""; // –ü—É—Å—Ç–æ–π ID –æ–∑–Ω–∞—á–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ

            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('edit-name').value = "";
            document.getElementById('edit-category').value = "";
            document.getElementById('edit-price').value = "";
            document.getElementById('edit-image').value = "";
            document.getElementById('edit-img-preview').src = "";
            document.getElementById('edit-desc').value = "";
            document.getElementById('edit-full-desc').value = "";
            document.getElementById('edit-badge').value = "";
            
            document.getElementById('edit-available').checked = true;
            document.getElementById('edit-popular').checked = false;

            // –°–±—Ä–æ—Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
            document.getElementById('modifiers-container').innerHTML = '';
            renderModifiers({}); 

            // –°–±—Ä–æ—Å –æ–±—ä–µ–º–æ–≤
            document.getElementById('volumes-container').innerHTML = '';

            populateCategoryList();
            modal.show();
        }

        // –û–¢–ö–†–´–¢–ò–ï –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
        window.openEdit = (id) => {
            const i = menuData.find(x => x._id === id);
            document.getElementById('modalTitle').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞";
            document.getElementById('edit-id').value = id;

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
            document.getElementById('edit-name').value = i.name || "";
            document.getElementById('edit-category').value = i.category || "";
            document.getElementById('edit-price').value = i.price || 0;
            document.getElementById('edit-image').value = i.image || "";
            document.getElementById('edit-img-preview').src = i.image || "";
            document.getElementById('edit-desc').value = i.description || "";
            document.getElementById('edit-full-desc').value = i.full_description || i.description || "";
            document.getElementById('edit-badge').value = i.badge || "";

            document.getElementById('edit-available').checked = i.available !== false;
            document.getElementById('edit-popular').checked = i.popular === true;

            // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
            document.getElementById('modifiers-container').innerHTML = '';
            renderModifiers(i.modifiers || {});

            // –û–±—ä–µ–º—ã
            document.getElementById('volumes-container').innerHTML = '';
            (i.volumes || []).forEach(v => addVolumeRow(v.n, v.p));

            populateCategoryList();
            modal.show();
        }

        function renderModifiers(currentMods) {
            const mc = document.getElementById('modifiers-container');
            MOD_CONFIG.forEach(c => {
                const chk = c.key in currentMods;
                let pr = c.def;
                if (chk) {
                    const val = currentMods[c.key];
                    if (Array.isArray(val)) {
                        pr = val.join('|');
                    } else {
                        pr = val;
                    }
                }

                mc.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-2 pb-1 border-bottom">
              <div class="form-check mb-0">
                  <input class="form-check-input mod-cb" type="checkbox" id="m_${c.key}" data-key="${c.key}" ${chk ? 'checked' : ''}>
                  <label class="form-check-label small" for="m_${c.key}">${c.label}</label>
              </div>
              <input type="text" class="form-control form-control-sm text-end mod-price-inp" style="width:100px" id="mp_${c.key}" value="${pr}" placeholder="–¶–µ–Ω–∞">
          </div>`;
            });
        }

        window.addVolumeRow = (n = '', p = '') => {
            const div = document.createElement('div');
            div.className = 'd-flex gap-2 mb-2 vol-row';
            div.innerHTML = `
          <input type="text" class="form-control form-control-sm" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (0.3)" value="${n}">
          <input type="number" class="form-control form-control-sm" placeholder="–¶–µ–Ω–∞" value="${p}" style="width: 100px;">
          <button class="btn btn-sm text-danger border-0 px-2" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
      `;
            document.getElementById('volumes-container').appendChild(div);
        }

        window.saveItem = async () => {
            const id = document.getElementById('edit-id').value;

            // –°–±–æ—Ä –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
            const mods = {};
            document.querySelectorAll('.mod-cb').forEach(cb => {
                if (cb.checked) {
                    const rawVal = document.getElementById(`mp_${cb.dataset.key}`).value;
                    let val;
                    if (rawVal.includes('|')) {
                        val = rawVal.split('|').map(v => parseInt(v.trim()) || 0);
                    } else {
                        val = parseInt(rawVal) || 0;
                    }
                    mods[cb.dataset.key] = val;
                }
            });

            // –°–±–æ—Ä –æ–±—ä–µ–º–æ–≤
            const vols = [];
            document.querySelectorAll('.vol-row').forEach(r => {
                const inputs = r.querySelectorAll('input');
                if (inputs[0].value) vols.push({ n: inputs[0].value, p: parseInt(inputs[1].value) || 0 });
            });

            // –û–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö
            const itemData = {
                name: document.getElementById('edit-name').value,
                category: document.getElementById('edit-category').value.toUpperCase().trim(), // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
                price: parseInt(document.getElementById('edit-price').value) || 0,
                image: document.getElementById('edit-image').value,
                description: document.getElementById('edit-desc').value,
                full_description: document.getElementById('edit-full-desc').value,
                badge: document.getElementById('edit-badge').value,
                available: document.getElementById('edit-available').checked,
                popular: document.getElementById('edit-popular').checked,
                modifiers: mods,
                volumes: vols
            };

            if (!itemData.name) {
                alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞!");
                return;
            }

            try {
                if (id) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
                    await updateDoc(doc(db, "menu", id), itemData);
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
                    await addDoc(collection(db, "menu"), itemData);
                }
                modal.hide();
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
                console.error(e);
            }
        }

        // === 2. –ó–ê–ö–ê–ó–´ (–ö–∞–∫ –±—ã–ª–æ) ===
        let orderUnsubscribe = null;
        window.loadOrders = async () => {
            const cont = document.getElementById('orders-container');
            if (orderUnsubscribe) orderUnsubscribe(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ–Ω –±—ã–ª

            cont.innerHTML = '<div class="text-center p-3 text-muted">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–æ—Ç–æ–∫—É –∑–∞–∫–∞–∑–æ–≤...</div>';

            const q = query(collection(db, "orders"), orderBy("timestamp", "desc"), limit(50));

            let firstLoad = true;
            orderUnsubscribe = onSnapshot(q, (snap) => {
                if (snap.empty) {
                    cont.innerHTML = '<div class="text-center text-muted p-4">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞</div>';
                    return;
                }

                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –¥–æ–±–∞–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
                if (!firstLoad) {
                    snap.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            playNotificationSound();
                        }
                    });
                }
                firstLoad = false;

                let orders = [];
                snap.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

                cont.innerHTML = '';
                orders.forEach(d => {
                    const od = d.order_data || {};
                    const info = od.info || {};
                    const cart = od.cart || [];
                    const total = d.total_price || od.total || 0;
                    let dateStr = "???";
                    if (d.timestamp && d.timestamp.seconds) dateStr = new Date(d.timestamp.seconds * 1000).toLocaleString('ru-RU');
                    else if (d.date_str) dateStr = d.date_str;

                    const statusColors = {
                        'new': 'bg-primary',
                        'pending': 'bg-warning',
                        'accepted': 'bg-info',
                        'ready': 'bg-success',
                        'given': 'bg-secondary',
                        'rejected': 'bg-danger'
                    };
                    const currentStatus = d.status || 'new';

                    let itemsHtml = '';
                    if (Array.isArray(cart)) {
                        cart.forEach(i => {
                            let opts = (i.options || []).map(o => `‚Ä¢ ${o}`).join('<br>');
                            if (opts) opts = `<div class="small text-muted ps-3 mt-1" style="font-size:0.8em">${opts}</div>`;
                            itemsHtml += `<div class="border-bottom pb-2 mb-2"><div class="d-flex justify-content-between"><span>${i.name}</span><span class="badge bg-light text-dark border">x${i.qty}</span></div>${opts}</div>`;
                        });
                    }

                    cont.innerHTML += `
              <div class="card card-shadow order-card p-3 mb-3" style="border-left-color: ${currentStatus === 'new' ? '#007bff' : (currentStatus === 'rejected' ? '#dc3545' : '#88d100')}">
                  <div class="d-flex justify-content-between small text-muted mb-2">
                    <span>${dateStr}</span>
                    <span class="badge ${statusColors[currentStatus] || 'bg-secondary'}">${currentStatus.toUpperCase()}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                      <div class="fw-bold">${info.name || '–ö–ª–∏–µ–Ω—Ç'} <span class="fw-normal text-muted">${info.phone || ''}</span></div>
                      <div class="fs-5 fw-bold text-success">${total} ‚Ç∏</div>
                  </div>
                  <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="toggleOrder('${d.id}')">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤ (${cart.length})</button>
                  <div id="order-details-${d.id}" style="display:none" class="bg-light p-2 rounded small">
                      ${itemsHtml}
                      ${info.address ? `<div class="mt-2 border-top pt-2">üìç ${info.address}</div>` : ''}
                      ${info.comment ? `<div class="text-danger">üí¨ ${info.comment}</div>` : ''}
                      <div class="mt-2 pt-2 border-top d-flex gap-2">
                          <button class="btn btn-xs btn-outline-danger" onclick="updateOrderStatus('${d.id}', 'rejected')">–û—Ç–º–µ–Ω–∞</button>
                          <button class="btn btn-xs btn-outline-success" onclick="updateOrderStatus('${d.id}', 'ready')">–ì–æ—Ç–æ–≤</button>
                      </div>
                  </div>
              </div>`;
                });
            }, (err) => {
                cont.innerHTML = "–û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞: " + err.message;
            });
        }

        window.updateOrderStatus = async (id, status) => {
            try {
                await updateDoc(doc(db, "orders", id), { status: status });
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: " + e.message);
            }
        }

        function playNotificationSound() {
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.play().catch(e => console.log("Sound play failed (interaction required):", e));
        }
        window.toggleOrder = (id) => {
            const el = document.getElementById(`order-details-${id}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // === 3. –ü–†–û–ú–û–ö–û–î–´ ===
        window.loadPromos = async () => {
            const cont = document.getElementById('promos-container');
            const snap = await getDocs(collection(db, "promocodes"));
            cont.innerHTML = '';
            if (snap.empty) cont.innerHTML = '<div class="text-muted p-3">–ü—É—Å—Ç–æ</div>';
            snap.forEach(d => {
                const p = d.data();
                const disc = Math.round((p.discount || 0) * 100);
                cont.innerHTML += `
          <div class="card card-shadow p-3 mb-2 d-flex flex-row justify-content-between align-items-center">
              <div>
                  <span class="promo-code">${d.id}</span> <span class="badge bg-success">-${disc}%</span>
                  <div class="small text-muted mt-1">–û—Å—Ç–∞–ª–æ—Å—å: ${p.limit || 0}</div>
              </div>
              <div>
                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="showPromoHistory('${d.id}')"><i class="fas fa-history"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="delPromo('${d.id}')"><i class="fas fa-trash"></i></button>
              </div>
          </div>`;
            });
        }

        // === –ò–°–¢–û–†–ò–Ø –ü–†–û–ú–û ===
        const historyModal = new bootstrap.Modal(document.getElementById('promoHistoryModal'));
        window.showPromoHistory = async (code) => {
            document.getElementById('hist-promo-code').innerText = code;
            const list = document.getElementById('promo-history-list'); list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            historyModal.show();
            const q = query(collection(db, "promo_history"), where("code", "==", code));
            const snap = await getDocs(q);
            list.innerHTML = '';
            if (snap.empty) list.innerHTML = '<div class="text-muted small">–ü—É—Å—Ç–æ</div>';
            snap.forEach(d => {
                const h = d.data();
                let date = h.timestamp?.seconds ? new Date(h.timestamp.seconds * 1000).toLocaleString() : '';
                list.innerHTML += `<div class="d-flex justify-content-between border-bottom py-2 small"><div><b>${h.user_id}</b><br><span class="text-muted">${date}</span></div><button class="btn btn-sm btn-outline-danger py-0" onclick="resetPromoUsage('${code}','${d.id}')">–°–±—Ä–æ—Å</button></div>`;
            });
        }
        window.resetPromoUsage = async (code, docId) => {
            if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å?")) return;
            await runTransaction(db, async (t) => {
                const pRef = doc(db, "promocodes", code);
                const snap = await t.get(pRef);
                if (!snap.exists()) throw "Error";
                t.delete(doc(db, "promo_history", docId));
                t.update(pRef, { limit: (snap.data().limit || 0) + 1 });
            });
            showPromoHistory(code); loadPromos();
        }

        window.addPromo = async () => {
            const code = document.getElementById('new-promo-code').value.toUpperCase().trim();
            const disc = parseFloat(document.getElementById('new-promo-disc').value);
            const limit = parseInt(document.getElementById('new-promo-limit').value);
            if (!code || !disc) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
            await setDoc(doc(db, "promocodes", code), { discount: disc / 100, limit: limit, created_at: new Date() });
            document.getElementById('new-promo-code').value = ''; loadPromos();
        }
        window.delPromo = async (id) => { if (confirm("–£–¥–∞–ª–∏—Ç—å?")) { await deleteDoc(doc(db, "promocodes", id)); loadPromos(); } }

        // === 4. –û–¢–ó–´–í–´ ===
        window.loadReviews = async () => {
            const cont = document.getElementById('reviews-container');
            const q = query(collection(db, "reviews"), limit(50));
            const snap = await getDocs(q);
            let revs = [];
            snap.forEach(d => revs.push(d.data()));
            revs.sort((a, b) => new Date(b.date_str || 0) - new Date(a.date_str || 0));
            cont.innerHTML = '';
            if (revs.length === 0) cont.innerHTML = '<div class="text-muted text-center p-3">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>';
            revs.forEach(r => {
                const avg = Math.round(((r.service_rate || 0) + (r.food_rate || 0)) / 2) || 5;
                const stars = '‚≠ê'.repeat(avg);
                cont.innerHTML += `<div class="card card-shadow p-3 mb-2"><div class="d-flex justify-content-between small text-muted"><span>${r.name || '–ì–æ—Å—Ç—å'}</span><span>${r.date_str || ''}</span></div><div class="mb-1">${stars}</div><p class="small mb-0 text-secondary">${r.comment || r.text || ''}</p>${r.tips ? `<div class="small text-success fw-bold mt-1">${r.tips} ‚Ç∏ —á–∞–µ–≤—ã—Ö</div>` : ''}</div>`;
            });
        }

        // –≠–∫—Å–ø–æ—Ä—Ç
        window.loadOrders = window.loadOrders;
        window.loadPromos = window.loadPromos;
        window.addPromo = window.addPromo;
        window.delPromo = window.delPromo;
        window.loadReviews = window.loadReviews;
        window.showPromoHistory = window.showPromoHistory;
        window.resetPromoUsage = window.resetPromoUsage;
        window.toggleOrder = window.toggleOrder;
        window.updateOrderStatus = window.updateOrderStatus;
        window.openAdd = window.openAdd;
        window.openEdit = window.openEdit;

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
