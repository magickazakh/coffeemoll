name: ☕ Keep-Alive & Monitor

on:
  schedule:
    # ИЗМЕНЕНИЕ: Ставим каждые 8 минут (*/8) вместо 14.
    # Это создаст запас прочности, если GitHub задержит запуск на пару минут.
    # Render засыпает через 15 минут. 8 мин + 5 мин (лаг) = 13 мин < 15 мин.
    - cron: '*/5 3-18 * * *'
  
  workflow_dispatch:

jobs:
  ping-render:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up Render
        env:
          URL: ${{ secrets.SITE_URL }}
          TOKEN: ${{ secrets.TELEGRAM_TOKE }}
          CHAT_ID: ${{ secrets.TELEGRAM_TO }}
        run: |
          # Используем User-Agent как у браузера, чтобы Render точно засчитал это как активность
          http_code=$(curl -o /dev/null -s -w "%{http_code}\n" --max-time 60 --retry 3 -A "Mozilla/5.0 (KeepAlive)" "$URL")
          
          echo "Response Code: $http_code"
          
          if [ "$http_code" -ne 200 ]; then
            # Если ошибка, пробуем разбудить еще раз через 5 секунд (контрольный выстрел)
            sleep 5
            http_code_retry=$(curl -o /dev/null -s -w "%{http_code}\n" --max-time 60 -A "Mozilla/5.0 (KeepAlive)" "$URL")
            
            if [ "$http_code_retry" -ne 200 ]; then
                # Если и второй раз не ответил - шлем тревогу
                curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                -d text="⚠️ <b>Render спит!</b>%0AКод: $http_code" \
                -d parse_mode="HTML"
                exit 1
            fi
          else
            echo "✅ Render бодрствует."
          fi
